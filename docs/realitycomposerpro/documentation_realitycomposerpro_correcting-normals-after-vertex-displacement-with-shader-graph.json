{
  "abstract" : "Approximate new vertex normals for materials that displace a mesh’s vertices.",
  "codeExamples" : [

  ],
  "contentHash" : "a95e3aa6654b13b27a5af61ce9e091f087d8050362419a59610ef76a2d4f3e79",
  "crawledAt" : "2025-12-02T15:56:02Z",
  "id" : "2D2F5C81-11A3-4E92-B618-CB559FB5D049",
  "kind" : "article",
  "language" : "swift",
  "overview" : "## Overview\n\nVertex displacement shaders can create a myriad of dynamic effects, such as water, terrain, and undulating surfaces. However, displacing vertex positions without correcting the vertex normals can result in incorrect lighting, as shown in the examples below:\n\nAssuming the vertices of your mesh have correct normals predisplacement, and the displacement is a continuous function of the vertex positions in model space, you can correct the normals of your vertex displacement shader by sampling the displacement of neighboring points along the surface of the mesh and approximating a new normal direction with the cross product.\n\nFor each vertex in the mesh, find two neighboring points on the surface of the mesh that are in orthogonal directions to one another. Approximate the new normal direction by displacing these points with the same function that displaces the original vertex, and then take the cross product between the new vectors pointing toward them. See [doc:\/\/RealityComposerPro\/documentation\/RealityComposerPro\/loading-entities-with-shadergraph-materials] to download a sample project containing this shader along with many others.\n\n## Create a displacement node graph\n\nStart by creating a node graph that takes a position input in `object` or `model` space and outputs a model position offset vector. See [doc:\/\/RealityComposerPro\/documentation\/RealityComposerPro\/Creating-a-vertex-displacement-material-with-Shader-Graph] for one such example, replicated below:\n\n\n\nIn this example, the Displacement node graph is as follows:\n\n\n\n## Set up the offset and normal node graph\n\nCreate the outline for a node graph that calculates the model position offset and the new normal direction in tandem:\n\nThe main body of the shader is shown here:\n\n\n\nSee the interior of the OffsetAndNormal node graph below:\n\n\n\n## Set up the neighbors node graph\n\nPrepare a new node graph to calculate two orthogonal neighboring positions at a given distance away from a given vertex position:\n\nThe interior of the OffsetAndNormal node graph is as follows:\n\n\n\n## Find neighboring positions along the surface\n\nCalculate two orthogonal neighbor positions inside the Neighbors node graph:\n\nThe interior of the Neighbors node graph is as follows:\n\n\n\nWhile this node graph outputs orthogonal neighboring positions under most circumstances, it fails when the normal vector is similar or equal to the arbitrary unit vector you take the cross product with to get the tangent. One approach to remedying this issue is to compute the similarity between the normal and the arbitrary unit vector with a dot product, and then linearly interpolate toward a different arbitrary unit vector by the similarity value before computing the first tangent, as shown here:\n\n\n\n## Sample the displacement at the neighboring positions\n\nCalculate the model position offset at both of the neighboring positions by making instances of your Displacement node graph:\n\nPerform these steps inside the OffsetAndNormal node graph, connecting the Amplitude, Rate, and Scale input nodes to the corresponding inputs of each Displacement node, as shown in the image below:\n\n\n\n## Compute the new normal direction\n\nCalculate the new normal direction by taking the cross product between the directions from the displaced vertex position to the displaced neighbor positions:\n\nThe resulting node graph is as follows:\n\n\n\nThe following videos show the result of correcting the normals for a shader displacing the vertices of a plane mesh:",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/Correcting-normals-after-vertex-displacement-with-Shader-Graph\ncrawled: 2025-12-02T15:56:02Z\n---\n\n# Correcting normals after vertex displacement with Shader Graph\n\n**Article**\n\nApproximate new vertex normals for materials that displace a mesh’s vertices.\n\n## Overview\n\nVertex displacement shaders can create a myriad of dynamic effects, such as water, terrain, and undulating surfaces. However, displacing vertex positions without correcting the vertex normals can result in incorrect lighting, as shown in the examples below:\n\n\n\nAssuming the vertices of your mesh have correct normals predisplacement, and the displacement is a continuous function of the vertex positions in model space, you can correct the normals of your vertex displacement shader by sampling the displacement of neighboring points along the surface of the mesh and approximating a new normal direction with the cross product.\n\nFor each vertex in the mesh, find two neighboring points on the surface of the mesh that are in orthogonal directions to one another. Approximate the new normal direction by displacing these points with the same function that displaces the original vertex, and then take the cross product between the new vectors pointing toward them. See [doc:\/\/RealityComposerPro\/documentation\/RealityComposerPro\/loading-entities-with-shadergraph-materials] to download a sample project containing this shader along with many others.\n\n## Create a displacement node graph\n\nStart by creating a node graph that takes a position input in `object` or `model` space and outputs a model position offset vector. See [doc:\/\/RealityComposerPro\/documentation\/RealityComposerPro\/Creating-a-vertex-displacement-material-with-Shader-Graph] for one such example, replicated below:\n\n\n\nIn this example, the Displacement node graph is as follows:\n\n\n\n## Set up the offset and normal node graph\n\nCreate the outline for a node graph that calculates the model position offset and the new normal direction in tandem:\n\n1. Select the Displacement node graph and all of its inputs.\n2. Control-click on one of the selected nodes and choose Compose Node Graph from the contextual menu.\n3. Name the new [https:\/\/developer.apple.com\/documentation\/shadergraph\/material\/nodegraph] node “OffsetAndNormal”.\n4. Add a new output of type `Vector3 (Float)` to the OffsetAndNormal node graph and name it “Normal”.\n5. Connect the `Normal` output of the OffsetAndNormal node graph to the `Normal` input of the `Geometry Modifier` node.\n6. Open the OffsetAndNormal node graph and optionally rename its inputs and outputs.\n\nThe main body of the shader is shown here:\n\n\n\nSee the interior of the OffsetAndNormal node graph below:\n\n\n\n## Set up the neighbors node graph\n\nPrepare a new node graph to calculate two orthogonal neighboring positions at a given distance away from a given vertex position:\n\n1. Inside the OffsetAndNormal node graph, add a new `NodeGraph` node and name it “Neighbors”.\n2. Add a new input of type `Float` to the Neighbors node and name it “Distance”.\n3. Add a new input of type `Vector3 (Float)` to the Neighbors node and name it “Position”.\n4. Add a new output of type `Vector3 (Float)` to the Neighbors node graph and name it “Neighbor1Position”.\n5. Add a new output of type `Vector3 (Float)` to the Neighbors node graph and name it “Neighbor2Position”.\n6. Connect the Position node to the `Position` input of the Neighbors node.\n7. Set the `Distance` input value of the Neighbors node to a small value, such as 0.01.\n\nThe interior of the OffsetAndNormal node graph is as follows:\n\n\n\n\n\n## Find neighboring positions along the surface\n\nCalculate two orthogonal neighbor positions inside the Neighbors node graph:\n\n1. Add a [https:\/\/developer.apple.com\/documentation\/shadergraph\/geometric\/normal] node and set its `Space` to `object`.\n2. Calculate a vector orthogonal to the normal (tangent to the surface) by taking the cross product of the `Normal` node with an arbitrary unit vector, such as (1, 0, 0), using a [https:\/\/developer.apple.com\/documentation\/shadergraph\/math\/cross-product] node. Name it “Tangent”.\n3. Compute the cross product of the Tangent `Cross Product` node with the Normal node and name it “Bitangent”. This produces a second vector orthogonal to the normal, but also tangent to the surface of the mesh.\n4. Normalize the output of both the Tangent and the Bitangent `Cross Product` nodes with [https:\/\/developer.apple.com\/documentation\/shadergraph\/math\/normalize] nodes.\n5. Multiply the output of both the `Normalize` nodes by the `Distance` input with [https:\/\/developer.apple.com\/documentation\/shadergraph\/math\/multiply] nodes.\n6. Compute the two neighbor positions by adding the `Position` input to the result of both the `Multiply` nodes with [https:\/\/developer.apple.com\/documentation\/shadergraph\/math\/add] nodes.\n7. Connect the output of the `Add` nodes to the `Neighbor1Position` and `Neighbor2Position` outputs.\n\nThe interior of the Neighbors node graph is as follows:\n\n\n\nWhile this node graph outputs orthogonal neighboring positions under most circumstances, it fails when the normal vector is similar or equal to the arbitrary unit vector you take the cross product with to get the tangent. One approach to remedying this issue is to compute the similarity between the normal and the arbitrary unit vector with a dot product, and then linearly interpolate toward a different arbitrary unit vector by the similarity value before computing the first tangent, as shown here:\n\n\n\n## Sample the displacement at the neighboring positions\n\nCalculate the model position offset at both of the neighboring positions by making instances of your Displacement node graph:\n\n1. Create two instances of your Displacement node graph (in the Inspector, Control-click > Create Instance), naming one “DisplacementNeighbor1” and the other “DisplacementNeighbor2”.\n2. Connect the `Neighbor1Position` output of the Neighbors node graph to the `Position` input of the DisplacementNeighbor1 node graph instance.\n3. Connect the `Neighbor2Position` output of the Neighbors node graph to the `Position` input of the DisplacementNeighbor2 node graph instance.\n\nPerform these steps inside the OffsetAndNormal node graph, connecting the Amplitude, Rate, and Scale input nodes to the corresponding inputs of each Displacement node, as shown in the image below:\n\n\n\n\n\n## Compute the new normal direction\n\nCalculate the new normal direction by taking the cross product between the directions from the displaced vertex position to the displaced neighbor positions:\n\n1. For each of the three displacement nodes, get the displaced position by adding the same value connected to the `Position` input of the node to the `Model Position Offset` output of the node with an `Add` node.\n2. Calculate the vectors pointing from the displaced vertex position to the displaced neighbor positions by subtracting the original displaced vertex position from the displaced neighbor positions with [https:\/\/developer.apple.com\/documentation\/shadergraph\/math\/subtract] nodes.\n3. Take the cross product between the vectors with a `Cross Product` node to get the new normal direction. Name it “Normal”.\n4. Normalize the normal direction with a `Normalize` node.\n5. Connect the normalized normal direction to the `Normal` output.\n\nThe resulting node graph is as follows:\n\n\n\nThe following videos show the result of correcting the normals for a shader displacing the vertices of a plane mesh:\n\n\n\n## Shader Graph\n\n- **Designing materials with Shader Graph**: Create realistic materials with Shader Graph’s node editor in Reality Composer Pro.\n- **Loading entities with ShaderGraph materials**: Bring entities that contain materials created with Reality Composer Pro for use in your visionOS app.\n- **Creating a Fresnel outline effect with Shader Graph**: Highlight a model by adding an outline effect.\n- **Creating a vertex displacement material with Shader Graph**: Animate the vertices of a mesh over time with 3D Perlin noise by creating a Shader Graph material.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Create realistic materials with Shader Graph’s node editor in Reality Composer Pro.",
          "name" : "Designing materials with Shader Graph",
          "url" : "https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/Editor_ShaderGraph"
        },
        {
          "description" : "Bring entities that contain materials created with Reality Composer Pro for use in your visionOS app.",
          "name" : "Loading entities with ShaderGraph materials",
          "url" : "https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/loading-entities-with-shadergraph-materials"
        },
        {
          "description" : "Highlight a model by adding an outline effect.",
          "name" : "Creating a Fresnel outline effect with Shader Graph",
          "url" : "https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/Creating-a-Fresnel-outline-effect-with-Shader-Graph"
        },
        {
          "description" : "Animate the vertices of a mesh over time with 3D Perlin noise by creating a Shader Graph material.",
          "name" : "Creating a vertex displacement material with Shader Graph",
          "url" : "https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/Creating-a-vertex-displacement-material-with-Shader-Graph"
        }
      ],
      "title" : "Shader Graph"
    }
  ],
  "source" : "appleJSON",
  "title" : "Correcting normals after vertex displacement with Shader Graph",
  "url" : "https:\/\/developer.apple.com\/documentation\/RealityComposerPro\/Correcting-normals-after-vertex-displacement-with-Shader-Graph"
}