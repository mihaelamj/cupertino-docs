{
  "abstract" : "Simulate a bokeh effect by applying dilation.",
  "codeExamples" : [
    {
      "code" : "\/\/\/ The number of edges on the bokeh polygon.\n@Published var diaphragmBladeCount = 6.0 {\n    didSet {\n        Task(priority: .userInitiated) {\n            await applyBokeh()\n        }\n    }\n}",
      "language" : "swift"
    },
    {
      "code" : "let bokeh = Self.makeBokehStructuringElement(ofRadius: Int(bokehRadius),\n                                             atAngle: angle,\n                                             withSides: Int(diaphragmBladeCount))",
      "language" : "swift"
    },
    {
      "code" : "\/\/\/ Apply dilation to the red channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceRedBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                    destination: destinationRedBuffer)\n}\n\n\/\/\/ Apply dilation to the green channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceGreenBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                      destination: destinationGreenBuffer)\n}\n\n\/\/\/ Apply dilation to the blue channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceBlueBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                     destination: destinationBlueBuffer)\n}",
      "language" : "swift"
    }
  ],
  "contentHash" : "65753283bde1b7901f66014a2bd517d8f983f3e0a07f93de569b83dd66a451b5",
  "crawledAt" : "2025-12-02T15:27:42Z",
  "id" : "261AD1E0-C4C9-49D9-BA80-68C88C1CFB90",
  "kind" : "unknown",
  "language" : "swift",
  "module" : "Accelerate",
  "overview" : "## Overview\n\nThis sample app creates a bokeh effect, where parts of an image that are out of focus adopt the shape of the lens’s aperture. The app dynamically generates a polygon-shaped kernel — also known as a *structuring element* — and applies a morphology operation to an image based on that kernel. The following sample shows a photograph after the app has applied dilation with a triangular kernel:\n\n\n\nKernels are 1D or 2D matrices of values that the morphology operation subtracts from a corresponding pixel value in the image. The final value of each transformed pixel is either the lightest result (for dilation) or darkest result (for erosion) of each subtraction.\n\n\n\nThe following formula shows how a dilation operation calculates the value for the pixel at the center of the grid. The operation subtracts each of the nine kernel values from the image’s corresponding pixel and returns the maximum value.\n\n\n\n### Generate the structuring element\n\nThe `MorphologyTransformer.makeBokehStructuringElement(ofRadius:atAngle:withSides:)` method returns a [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/vImage\/StructuringElement] structure. Within that structure, the `diaphragmBladeCount` variable defines the number of sides. For example, to create a hexagon-shaped bokeh effect, the sample app calls the `MorphologyTransformer.makeBokehStructuringElement(ofRadius:atAngle:withSides:)` method with the number of sides set to `6`.\n\nOn return, `bokeh` contains the following values:\n\n\n\n### Apply the dilation\n\nTo optimize the dilation operations, the sample app calls the planar morphology function, [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/vImage\/PixelBuffer\/applyMorphology(operation:destination:)-1aqer], concurrently on the three planar pixel buffers that represent the individual red, green, and blue channels.\n\nTo learn more about improving your app’s performance by converting image buffer formats from interleaved to planar, see [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/optimizing-image-processing-performance].\n\nThe following code calls the three functions inside a [doc:\/\/com.apple.documentation\/documentation\/Swift\/withTaskGroup(of:returning:isolation:body:)] closure:\n\nOn return, the destination buffer contains the dilation result:\n\n",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Accelerate\/adding-a-bokeh-effect-to-images\ncrawled: 2025-12-02T15:27:42Z\n---\n\n# Adding a bokeh effect to images\n\n**Sample Code**\n\nSimulate a bokeh effect by applying dilation.\n\n## Overview\n\nThis sample app creates a bokeh effect, where parts of an image that are out of focus adopt the shape of the lens’s aperture. The app dynamically generates a polygon-shaped kernel — also known as a *structuring element* — and applies a morphology operation to an image based on that kernel. The following sample shows a photograph after the app has applied dilation with a triangular kernel:\n\n\n\nKernels are 1D or 2D matrices of values that the morphology operation subtracts from a corresponding pixel value in the image. The final value of each transformed pixel is either the lightest result (for dilation) or darkest result (for erosion) of each subtraction.\n\n\n\nThe following formula shows how a dilation operation calculates the value for the pixel at the center of the grid. The operation subtracts each of the nine kernel values from the image’s corresponding pixel and returns the maximum value.\n\n\n\n### Generate the structuring element\n\nThe `MorphologyTransformer.makeBokehStructuringElement(ofRadius:atAngle:withSides:)` method returns a [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/vImage\/StructuringElement] structure. Within that structure, the `diaphragmBladeCount` variable defines the number of sides. For example, to create a hexagon-shaped bokeh effect, the sample app calls the `MorphologyTransformer.makeBokehStructuringElement(ofRadius:atAngle:withSides:)` method with the number of sides set to `6`.\n\n```swift\n\/\/\/ The number of edges on the bokeh polygon.\n@Published var diaphragmBladeCount = 6.0 {\n    didSet {\n        Task(priority: .userInitiated) {\n            await applyBokeh()\n        }\n    }\n}\n```\n\n```swift\nlet bokeh = Self.makeBokehStructuringElement(ofRadius: Int(bokehRadius),\n                                             atAngle: angle,\n                                             withSides: Int(diaphragmBladeCount))\n```\n\nOn return, `bokeh` contains the following values:\n\n\n\n### Apply the dilation\n\nTo optimize the dilation operations, the sample app calls the planar morphology function, [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/vImage\/PixelBuffer\/applyMorphology(operation:destination:)-1aqer], concurrently on the three planar pixel buffers that represent the individual red, green, and blue channels.\n\nTo learn more about improving your app’s performance by converting image buffer formats from interleaved to planar, see [doc:\/\/com.apple.accelerate\/documentation\/Accelerate\/optimizing-image-processing-performance].\n\nThe following code calls the three functions inside a [doc:\/\/com.apple.documentation\/documentation\/Swift\/withTaskGroup(of:returning:isolation:body:)] closure:\n\n```swift\n\/\/\/ Apply dilation to the red channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceRedBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                    destination: destinationRedBuffer)\n}\n\n\/\/\/ Apply dilation to the green channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceGreenBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                      destination: destinationGreenBuffer)\n}\n\n\/\/\/ Apply dilation to the blue channel.\ngroup.addTask(priority: .userInitiated) { [self] in\n    sourceBlueBuffer.applyMorphology(operation: .dilate(structuringElement: bokeh),\n                                     destination: destinationBlueBuffer)\n}\n```\n\nOn return, the destination buffer contains the dilation result:\n\n\n\n## Convolution and Morphology\n\n- **Blurring an image**: Filter an image by convolving it with custom and high-speed kernels.\n- **Convolution**: Apply a convolution kernel to an image.\n- **Morphology**: Dilate and erode images.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Filter an image by convolving it with custom and high-speed kernels.",
          "name" : "Blurring an image",
          "url" : "https:\/\/developer.apple.com\/documentation\/Accelerate\/blurring-an-image"
        },
        {
          "description" : "Apply a convolution kernel to an image.",
          "name" : "Convolution",
          "url" : "https:\/\/developer.apple.com\/documentation\/Accelerate\/convolution"
        },
        {
          "description" : "Dilate and erode images.",
          "name" : "Morphology",
          "url" : "https:\/\/developer.apple.com\/documentation\/Accelerate\/morphology"
        }
      ],
      "title" : "Convolution and Morphology"
    }
  ],
  "source" : "appleJSON",
  "title" : "Adding a bokeh effect to images",
  "url" : "https:\/\/developer.apple.com\/documentation\/Accelerate\/adding-a-bokeh-effect-to-images"
}