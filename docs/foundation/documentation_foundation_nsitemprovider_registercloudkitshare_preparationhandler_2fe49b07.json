{
  "abstract" : "Registers a handler that prepares a new CloudKit share.",
  "codeExamples" : [
    {
      "code" : "func beginSharing(_ record: CKRecord) {\n    let itemProvider = NSItemProvider()\n        \n    \/\/ Register a handler that creates a CloudKit share using\n    \/\/ the provided record, and saves them both to the server\n    \/\/ before passing them to the sharing service.\n    itemProvider.registerCloudKitShare(preparationHandler: { completion in\n        let container = CKContainer.default()\n            \n        \/\/ Create a share and use the record the caller provides as \n        \/\/ its root record. \n        let share = CKShare(rootRecord: record)\n\n        \/\/ Create an operation that saves both the record and the \n        \/\/ share to CloudKit.\n        let records = [record, share]\n        let operation = CKModifyRecordsOperation(recordsToSave: records, \n                                                 recordIDsToDelete: nil)\n            \n        \/\/ If the save fails, pass the error to the completion handler.\n        \/\/ Otherwise, pass the new share and its container.\n        operation.modifyRecordsCompletionBlock = { _, _, error in\n            if let error = error {\n                completion(nil, nil, error)\n            } else {\n                completion(share, container, nil)\n            }\n        }\n            \n        \/\/ Set an appropriate QoS and add the operation to the\n        \/\/ container's queue to execute it.\n        operation.qualityOfService = .userInitiated\n        container.privateCloudDatabase.add(operation)\n    })\n        \n    let items = [itemProvider]\n        \n    \/\/ Create a cloud-sharing service and invoke it to begin sharing.\n    if let service = NSSharingService(named: .cloudSharing), \n       service.canPerform(withItems: items) {\n        service.perform(withItems: items)\n    }\n}",
      "language" : "swift"
    }
  ],
  "contentHash" : "5347b26ad56405e8a830d721e180c5a482f121458898deafc3957be6ea5c5055",
  "crawledAt" : "2025-12-02T21:06:22Z",
  "declaration" : {
    "code" : "func registerCloudKitShare(preparationHandler: @escaping (@escaping (CKShare?, CKContainer?, (any Error)?) -> Void) -> Void)",
    "language" : "swift"
  },
  "id" : "72B63976-CFD3-48D6-B2E6-28780569CF32",
  "kind" : "method",
  "language" : "swift",
  "module" : "Foundation",
  "overview" : "## Discussion\n\nUse this method to share a hierarchy of CloudKit records with other iCloud users. When the service invokes the handler, create an instance of [doc:\/\/com.apple.documentation\/documentation\/CloudKit\/CKShare] with a root record. Save the share to the server using [doc:\/\/com.apple.documentation\/documentation\/CloudKit\/CKModifyRecordsOperation]. The root record (and its hierarchy) must already exist on the server or be part of the same save operation. After the share saves, call `preparationCompletionHandler` with the saved share and its container. If the save fails, pass the error to the completion handler instead. Invoking the sharing service with a share you register using this method prompts the user to begin sharing.\n\nUse the [doc:\/\/com.apple.documentation\/documentation\/AppKit\/NSCloudSharingServiceDelegate] protocol to respond to any changes the sharing service makes.\n\nThe following example shows how to create an item provider with a handler that saves a share. It then invokes the cloud-sharing service with that provider.",
  "platforms" : [
    "macOS"
  ],
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Foundation\/NSItemProvider\/registerCloudKitShare(preparationHandler:)\ncrawled: 2025-12-02T21:06:22Z\n---\n\n# registerCloudKitShare(preparationHandler:)\n\n**Instance Method**\n\nRegisters a handler that prepares a new CloudKit share.\n\n## Declaration\n\n```swift\nfunc registerCloudKitShare(preparationHandler: @escaping (@escaping (CKShare?, CKContainer?, (any Error)?) -> Void) -> Void)\n```\n\n## Parameters\n\n- **preparationHandler**: The handler the service invokes when it requires the CloudKit share.\n\n## Discussion\n\nUse this method to share a hierarchy of CloudKit records with other iCloud users. When the service invokes the handler, create an instance of [doc:\/\/com.apple.documentation\/documentation\/CloudKit\/CKShare] with a root record. Save the share to the server using [doc:\/\/com.apple.documentation\/documentation\/CloudKit\/CKModifyRecordsOperation]. The root record (and its hierarchy) must already exist on the server or be part of the same save operation. After the share saves, call `preparationCompletionHandler` with the saved share and its container. If the save fails, pass the error to the completion handler instead. Invoking the sharing service with a share you register using this method prompts the user to begin sharing.\n\nUse the [doc:\/\/com.apple.documentation\/documentation\/AppKit\/NSCloudSharingServiceDelegate] protocol to respond to any changes the sharing service makes.\n\n\n\nThe following example shows how to create an item provider with a handler that saves a share. It then invokes the cloud-sharing service with that provider.\n\n```swift\nfunc beginSharing(_ record: CKRecord) {\n    let itemProvider = NSItemProvider()\n        \n    \/\/ Register a handler that creates a CloudKit share using\n    \/\/ the provided record, and saves them both to the server\n    \/\/ before passing them to the sharing service.\n    itemProvider.registerCloudKitShare(preparationHandler: { completion in\n        let container = CKContainer.default()\n            \n        \/\/ Create a share and use the record the caller provides as \n        \/\/ its root record. \n        let share = CKShare(rootRecord: record)\n\n        \/\/ Create an operation that saves both the record and the \n        \/\/ share to CloudKit.\n        let records = [record, share]\n        let operation = CKModifyRecordsOperation(recordsToSave: records, \n                                                 recordIDsToDelete: nil)\n            \n        \/\/ If the save fails, pass the error to the completion handler.\n        \/\/ Otherwise, pass the new share and its container.\n        operation.modifyRecordsCompletionBlock = { _, _, error in\n            if let error = error {\n                completion(nil, nil, error)\n            } else {\n                completion(share, container, nil)\n            }\n        }\n            \n        \/\/ Set an appropriate QoS and add the operation to the\n        \/\/ container's queue to execute it.\n        operation.qualityOfService = .userInitiated\n        container.privateCloudDatabase.add(operation)\n    })\n        \n    let items = [itemProvider]\n        \n    \/\/ Create a cloud-sharing service and invoke it to begin sharing.\n    if let service = NSSharingService(named: .cloudSharing), \n       service.canPerform(withItems: items) {\n        service.perform(withItems: items)\n    }\n}\n```\n\n## Registering CloudKit shares\n\n- **registerCloudKitShare(_:container:)**: Registers a CloudKit share for the user to modify.\n- **registerCKShare(_:container:allowedSharingOptions:)**: Registers an existing collaboration object on a server.\n- **registerCKShare(container:allowedSharingOptions:preparationHandler:)**: Creates and registers a new collaboration object using a collection of records to share.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Registers a CloudKit share for the user to modify.",
          "name" : "registerCloudKitShare(_:container:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/Foundation\/NSItemProvider\/registerCloudKitShare(_:container:)"
        },
        {
          "description" : "Registers an existing collaboration object on a server.",
          "name" : "registerCKShare(_:container:allowedSharingOptions:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/Foundation\/NSItemProvider\/registerCKShare(_:container:allowedSharingOptions:)"
        },
        {
          "description" : "Creates and registers a new collaboration object using a collection of records to share.",
          "name" : "registerCKShare(container:allowedSharingOptions:preparationHandler:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/Foundation\/NSItemProvider\/registerCKShare(container:allowedSharingOptions:preparationHandler:)"
        }
      ],
      "title" : "Registering CloudKit shares"
    }
  ],
  "source" : "appleJSON",
  "title" : "registerCloudKitShare(preparationHandler:)",
  "url" : "https:\/\/developer.apple.com\/documentation\/Foundation\/NSItemProvider\/registerCloudKitShare(preparationHandler:)"
}