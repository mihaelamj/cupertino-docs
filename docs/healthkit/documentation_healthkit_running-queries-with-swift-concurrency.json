{
  "abstract" : "Use Swift concurrency to manage one-shot and long-running queries.",
  "codeExamples" : [
    {
      "code" : "let workoutType = HKWorkoutType.workoutType()\n\n\/\/ Get the date one week ago.\nlet calendar = Calendar.current\nvar components = calendar.dateComponents([.year, .month, .day], from: Date())\ncomponents.day = components.day! - 7\nlet oneWeekAgo = calendar.date(from: components)\n\n\/\/ Create a predicate for all samples within the last week.\nlet inLastWeek = HKQuery.predicateForSamples(withStart: oneWeekAgo,\n                                             end: nil,\n                                             options: [.strictStartDate])",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Create the query descriptor.\nlet anchorDescriptor =\nHKAnchoredObjectQueryDescriptor(\n    predicates: [.workout(inLastWeek)],\n        anchor: myAnchor)",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Wait for the current results.\nlet results = try await anchorDescriptor.result(for: store)\n\n\/\/ Process the results.\nlet addedSamples = results.addedSamples\nlet deletedSamples = results.deletedObjects\n\n\/\/ Do something with the results here.\n\n\/\/ Update the anchor.\nmyAnchor = results.newAnchor",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Start a long-running query to monitor the HealthKit store.\nlet updateQueue = anchorDescriptor.results(for: store)\n\n\/\/ Wait for the initial results and each update.\nmyUpdateTask = Task {\n    for try await results in updateQueue {\n        \n        \/\/ Process the results.\n        let addedSamples = results.addedSamples\n        let deletedSamples = results.deletedObjects\n        myAnchor = results.newAnchor\n        \n        log.append(\"- \\(addedSamples.count) new workouts found.\\n\")\n        log.append(\"- \\(deletedSamples.count) deleted workouts found.\\n\")\n    }\n}",
      "language" : "swift"
    },
    {
      "code" : "func stopUpdates() {\n    myUpdateTask?.cancel()\n    myUpdateTask = nil\n}",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Returns all matching samples currently in the HealthKit Store.\nlet results = try await anchorDescriptor.result(for: store)\n\n\/\/ Sets up a long-running query that returns both the current matching samples\n\/\/ as well as any changes.\nlet updateQueue = anchorDescriptor.results(for: store)",
      "language" : "swift"
    }
  ],
  "contentHash" : "d3cdad744e03fc6c78f023997a9c81289dc95ac409d37a4fb4d4980c0eaab322",
  "crawledAt" : "2025-12-02T18:11:05Z",
  "id" : "D0E128C0-E92B-4413-A517-F5BF06DAF531",
  "kind" : "article",
  "language" : "swift",
  "module" : "HealthKit",
  "overview" : "## Overview\n\nHealthKit provides a Swift-only API for querying the HealthKit store using Swift concurrency. This API uses two protocols. Descriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] perform one-shot queries that return all matching results currently in the HealthKit store. Descriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery] perform long-running queries that continue to monitor the store and return updates as changes occur.\n\n### Building a Query Descriptor\n\nFor all queries, start by constructing the type and predicates that describe the desired data. The following code creates a type for workout samples, and a predicate that matches samples that started within the last week.\n\nNext, create a descriptor that represents the query itself. The following descriptor uses the previous type and predicate to search for all workouts added to the HealthKit store after the provided anchor that are less than one week old.\n\nYou can now use this descriptor to run your query.\n\n### Running a One-Shot Query\n\nDescriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] protocol can perform one-shot queries. Call the descriptor’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method to start the query. The query then gathers a snapshot of all the matching data currently in the HealthKit store.\n\nNote that the type that the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method returns varies based on the descriptor. For example, [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKSampleQueryDescriptor] returns an array of properly typed samples, while the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAnchoredObjectQueryDescriptor] returns a structure that contains arrays of added samples and deleted objects.\n\n### Running and Stopping Long-Running Queries\n\nDescriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery] protocol can create long-running queries that monitor the HealthKit store and return periodic updates. Here, the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery\/results(for:)] method returns an instance that adopts the [doc:\/\/com.apple.documentation\/documentation\/Swift\/AsyncSequence] protocol. Note that the call to [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery\/results(for:)] is synchronous, but accessing data from the sequence is asynchronous.\n\nThe following code uses a `for` loop to read updates from the sequence as they arrive. The first instance contains all matching samples currently in the HealthKit store. This is the same as the results that the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method returns. However, the system continues to monitor the HealthKit store, and returns new results as they appear.\n\nBy wrapping the `for` loop in a [doc:\/\/com.apple.documentation\/documentation\/Swift\/Task], you can cancel the task to stop the long-running query.\n\n### Choosing the Correct Query Type\n\nTo see the list of descriptors for one-shot queries, see the Conforming Types section of the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] protocol. For the list of long-running descriptors, see [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery].",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/HealthKit\/running-queries-with-swift-concurrency\ncrawled: 2025-12-02T18:11:05Z\n---\n\n# Running Queries with Swift Concurrency\n\n**Article**\n\nUse Swift concurrency to manage one-shot and long-running queries.\n\n## Overview\n\nHealthKit provides a Swift-only API for querying the HealthKit store using Swift concurrency. This API uses two protocols. Descriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] perform one-shot queries that return all matching results currently in the HealthKit store. Descriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery] perform long-running queries that continue to monitor the store and return updates as changes occur.\n\n### Building a Query Descriptor\n\nFor all queries, start by constructing the type and predicates that describe the desired data. The following code creates a type for workout samples, and a predicate that matches samples that started within the last week.\n\n```swift\nlet workoutType = HKWorkoutType.workoutType()\n\n\/\/ Get the date one week ago.\nlet calendar = Calendar.current\nvar components = calendar.dateComponents([.year, .month, .day], from: Date())\ncomponents.day = components.day! - 7\nlet oneWeekAgo = calendar.date(from: components)\n\n\/\/ Create a predicate for all samples within the last week.\nlet inLastWeek = HKQuery.predicateForSamples(withStart: oneWeekAgo,\n                                             end: nil,\n                                             options: [.strictStartDate])\n```\n\n\n\nNext, create a descriptor that represents the query itself. The following descriptor uses the previous type and predicate to search for all workouts added to the HealthKit store after the provided anchor that are less than one week old.\n\n```swift\n\/\/ Create the query descriptor.\nlet anchorDescriptor =\nHKAnchoredObjectQueryDescriptor(\n    predicates: [.workout(inLastWeek)],\n        anchor: myAnchor)\n```\n\nYou can now use this descriptor to run your query.\n\n### Running a One-Shot Query\n\nDescriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] protocol can perform one-shot queries. Call the descriptor’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method to start the query. The query then gathers a snapshot of all the matching data currently in the HealthKit store.\n\nNote that the type that the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method returns varies based on the descriptor. For example, [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKSampleQueryDescriptor] returns an array of properly typed samples, while the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAnchoredObjectQueryDescriptor] returns a structure that contains arrays of added samples and deleted objects.\n\n```swift\n\/\/ Wait for the current results.\nlet results = try await anchorDescriptor.result(for: store)\n\n\/\/ Process the results.\nlet addedSamples = results.addedSamples\nlet deletedSamples = results.deletedObjects\n\n\/\/ Do something with the results here.\n\n\/\/ Update the anchor.\nmyAnchor = results.newAnchor\n```\n\n### Running and Stopping Long-Running Queries\n\nDescriptors that adopt the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery] protocol can create long-running queries that monitor the HealthKit store and return periodic updates. Here, the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery\/results(for:)] method returns an instance that adopts the [doc:\/\/com.apple.documentation\/documentation\/Swift\/AsyncSequence] protocol. Note that the call to [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery\/results(for:)] is synchronous, but accessing data from the sequence is asynchronous.\n\nThe following code uses a `for` loop to read updates from the sequence as they arrive. The first instance contains all matching samples currently in the HealthKit store. This is the same as the results that the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery\/result(for:)] method returns. However, the system continues to monitor the HealthKit store, and returns new results as they appear.\n\n```swift\n\/\/ Start a long-running query to monitor the HealthKit store.\nlet updateQueue = anchorDescriptor.results(for: store)\n\n\/\/ Wait for the initial results and each update.\nmyUpdateTask = Task {\n    for try await results in updateQueue {\n        \n        \/\/ Process the results.\n        let addedSamples = results.addedSamples\n        let deletedSamples = results.deletedObjects\n        myAnchor = results.newAnchor\n        \n        log.append(\"- \\(addedSamples.count) new workouts found.\\n\")\n        log.append(\"- \\(deletedSamples.count) deleted workouts found.\\n\")\n    }\n}\n```\n\nBy wrapping the `for` loop in a [doc:\/\/com.apple.documentation\/documentation\/Swift\/Task], you can cancel the task to stop the long-running query.\n\n```swift\nfunc stopUpdates() {\n    myUpdateTask?.cancel()\n    myUpdateTask = nil\n}\n```\n\n### Choosing the Correct Query Type\n\nTo see the list of descriptors for one-shot queries, see the Conforming Types section of the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncQuery] protocol. For the list of long-running descriptors, see [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAsyncSequenceQuery].\n\n\n\n```swift\n\/\/ Returns all matching samples currently in the HealthKit Store.\nlet results = try await anchorDescriptor.result(for: store)\n\n\/\/ Sets up a long-running query that returns both the current matching samples\n\/\/ as well as any changes.\nlet updateQueue = anchorDescriptor.results(for: store)\n```\n\n## Swift concurrency support\n\n- **HKAsyncQuery**: A protocol that defines an asynchronous method for running queries.\n- **HKAsyncSequenceQuery**: A protocol that defines a method for running queries that returns results using an asynchronous sequence.\n- **HKSamplePredicate**: A predicate for queries that return a collection of matching sample objects.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "A protocol that defines an asynchronous method for running queries.",
          "name" : "HKAsyncQuery",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKAsyncQuery"
        },
        {
          "description" : "A protocol that defines a method for running queries that returns results using an asynchronous sequence.",
          "name" : "HKAsyncSequenceQuery",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKAsyncSequenceQuery"
        },
        {
          "description" : "A predicate for queries that return a collection of matching sample objects.",
          "name" : "HKSamplePredicate",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKSamplePredicate"
        }
      ],
      "title" : "Swift concurrency support"
    }
  ],
  "source" : "appleJSON",
  "title" : "Running Queries with Swift Concurrency",
  "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/running-queries-with-swift-concurrency"
}