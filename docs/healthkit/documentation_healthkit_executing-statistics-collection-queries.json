{
  "abstract" : "Calculate statistical data for graphs and charts.",
  "codeExamples" : [
    {
      "code" : "let calendar = Calendar.current\n\n\/\/ Create a 1-week interval.\nlet interval = DateComponents(day: 7)\n\n\/\/ Set the anchor for 3 a.m. on Monday.\nvar components = DateComponents(calendar: calendar,\n                                timeZone: calendar.timeZone,\n                                hour: 3,\n                                minute: 0,\n                                second: 0,\n                                weekday: 2)\n\nguard let anchorDate = calendar.nextDate(after: Date(),\n                                         matching: components,\n                                         matchingPolicy: .nextTime,\n                                         repeatedTimePolicy: .first,\n                                         direction: .backward) else {\n    fatalError(\"*** unable to find the previous Monday. ***\")\n}",
      "language" : "swift"
    },
    {
      "code" : "guard let quantityType = HKObjectType.quantityType(forIdentifier: .stepCount) else {\n    fatalError(\"*** Unable to create a step count type ***\")\n}\n\n\/\/ Create the query.\nlet query = HKStatisticsCollectionQuery(quantityType: quantityType,\n                                        quantitySamplePredicate: nil,\n                                        options: .cumulativeSum,\n                                        anchorDate: anchorDate,\n                                        intervalComponents: interval)",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Set the results handler.\nquery.initialResultsHandler = {\n    query, results, error in\n    \n    \/\/ Handle errors here.\n    if let error = error as? HKError {\n        switch (error.code) {\n        case .errorDatabaseInaccessible:\n            \/\/ HealthKit couldn't access the database because the device is locked.\n            return\n        default:\n            \/\/ Handle other HealthKit errors here.\n            return\n        }\n    }\n    \n    guard let statsCollection = results else {\n        \/\/ You should only hit this case if you have an unhandled error. Check for bugs \n        \/\/ in your code that creates the query, or explicitly handle the error.\n        assertionFailure(\"\")\n        return\n    }\n\n...",
      "language" : "swift"
    },
    {
      "code" : "...\n    \n    let endDate = Date()\n    let threeMonthsAgo = DateComponents(month: -3)\n    \n    guard let startDate = calendar.date(byAdding: threeMonthsAgo, to: endDate) else {\n        fatalError(\"*** Unable to calculate the start date ***\")\n    }\n    \n    \/\/ Plot the weekly step counts over the past 3 months.\n    var weeklyData = MyWeeklyData()\n    \n    \/\/ Enumerate over all the statistics objects between the start and end dates.\n    statsCollection.enumerateStatistics(from: startDate, to: endDate)\n    { (statistics, stop) in\n        if let quantity = statistics.sumQuantity() {\n            let date = statistics.startDate\n            let value = quantity.doubleValue(for: .count())\n            \n            \/\/ Extract each week's data.\n            weeklyData.addWeek(date: date, stepCount: Int(value))\n        }\n    }\n    \n    \/\/ Dispatch to the main queue to update the UI.\n    DispatchQueue.main.async {\n        myUpdateGraph(weeklyData: weeklyData)\n    }\n}",
      "language" : "swift"
    },
    {
      "code" : "healthStore.execute(query)",
      "language" : "swift"
    }
  ],
  "contentHash" : "927d70860244436f2fc4bea8040c05429cf5cf0c3d90c9b827cebe1577e73a6d",
  "crawledAt" : "2025-12-02T18:11:37Z",
  "id" : "0F74C3E7-42D8-4BCF-979A-82624377EA8F",
  "kind" : "article",
  "language" : "swift",
  "module" : "HealthKit",
  "overview" : "## Overview\n\nProduce data for graphs and charts using statistics collection queries. For example, you might create a statistics collection query that calculates the total number of steps for each day or the average heart rate for each hour.\n\nStatistics collection queries use an anchor point and a time interval to partition the set of matching samples into collections. The anchor point defines an arbitrary starting point. The position of this point often doesn’t matter. It could be in the future or in the past. Time intervals extend away from this anchor point in both directions.\n\n\n\nFor example, if you use a 1-day time interval, the anchor point defines the time when each collection begins. The exact date for the anchor point doesn’t matter. It could be 3:34 a.m., January 1, 1970 or 3:34 a.m., March 15, 2065. In both cases, the statistics collection query partitions the matching samples into days, starting each day at 3:34 a.m.\n\nThe statistics collection query then calculates common statistics over each time interval. You can use statistics queries to calculate the minimum, maximum, or average value of a set of discrete quantities, or to calculate the sum for cumulative quantities. Also, like observer queries, statistics collection queries can act as long-running queries, receiving updates when the HealthKit store’s content changes.\n\n### Create the Query\n\nStart by creating your anchor date and time interval. The following sample starts by creating a 1-week time interval. Next, it sets the anchor date to Monday morning at 3:00 a.m. Because the interval is 1 week long, the anchor’s exact date doesn’t matter. Each set of statistics represents exactly 1 week, starting on Monday at 3:00 a.m.\n\nNext, create the quantity type and the statistics collection query. The following code creates the quantity type for step counts and then creates the query itself.\n\n### Add Callback Handlers\n\nUnlike most other queries, you don’t set the callback block when you instantiate a statistics collection query. Instead, you can either set the initial result handler or the statistics update handler (or both) as needed for your app. In this case, the sample code just sets the initial results handler, letting it calculate statistics over the samples currently stored in HealthKit.\n\nIn your results handler, first check for and handle errors. Many [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKError\/Code] values indicate that you haven’t properly set up HealthKit. Always check HealthKit’s availability and request permission to read the specified data type before creating a query. For more information, see [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/setting-up-healthkit] and [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/authorizing-access-to-health-data].\n\nHowever, your app may need to explicitly check for some errors, depending on its needs. For example, if your app can run a query in the background, you need to check for and handle the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKError\/Code\/errorDatabaseInaccessible] error.\n\nAfter you handle any errors, process the incoming statistics data, and then update your app. Be sure to dispatch code that updates the user interface to the [doc:\/\/com.apple.documentation\/documentation\/Dispatch\/DispatchQueue\/main] queue.\n\nThe following code calculates the start and end times for a 3-month window and then iterates over all the time intervals in that window. The statistics collection passes the enumeration block a statistics object for each time interval between the start and end dates. However, if the time interval doesn’t contain any samples, the provided statistics’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKStatistics\/sumQuantity()] method returns `nil`. Therefore, the sample must check to see whether it has a valid quantity. If it does, it adds the data; otherwise, it skips the time interval.\n\nFinally, execute the query using the HealthKit store.\n\nSince the sample doesn’t provide an update results handler, when the initial results block finishes processing the data, the query stops automatically. If the sample had provided an update manager, the statistics collection query would continue to monitor the HealthKit store after it had generated the initial results.",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/HealthKit\/executing-statistics-collection-queries\ncrawled: 2025-12-02T18:11:37Z\n---\n\n# Executing Statistics Collection Queries\n\n**Article**\n\nCalculate statistical data for graphs and charts.\n\n## Overview\n\nProduce data for graphs and charts using statistics collection queries. For example, you might create a statistics collection query that calculates the total number of steps for each day or the average heart rate for each hour.\n\n\n\nStatistics collection queries use an anchor point and a time interval to partition the set of matching samples into collections. The anchor point defines an arbitrary starting point. The position of this point often doesn’t matter. It could be in the future or in the past. Time intervals extend away from this anchor point in both directions.\n\n\n\nFor example, if you use a 1-day time interval, the anchor point defines the time when each collection begins. The exact date for the anchor point doesn’t matter. It could be 3:34 a.m., January 1, 1970 or 3:34 a.m., March 15, 2065. In both cases, the statistics collection query partitions the matching samples into days, starting each day at 3:34 a.m.\n\nThe statistics collection query then calculates common statistics over each time interval. You can use statistics queries to calculate the minimum, maximum, or average value of a set of discrete quantities, or to calculate the sum for cumulative quantities. Also, like observer queries, statistics collection queries can act as long-running queries, receiving updates when the HealthKit store’s content changes.\n\n### Create the Query\n\nStart by creating your anchor date and time interval. The following sample starts by creating a 1-week time interval. Next, it sets the anchor date to Monday morning at 3:00 a.m. Because the interval is 1 week long, the anchor’s exact date doesn’t matter. Each set of statistics represents exactly 1 week, starting on Monday at 3:00 a.m.\n\n```swift\nlet calendar = Calendar.current\n\n\/\/ Create a 1-week interval.\nlet interval = DateComponents(day: 7)\n\n\/\/ Set the anchor for 3 a.m. on Monday.\nvar components = DateComponents(calendar: calendar,\n                                timeZone: calendar.timeZone,\n                                hour: 3,\n                                minute: 0,\n                                second: 0,\n                                weekday: 2)\n\nguard let anchorDate = calendar.nextDate(after: Date(),\n                                         matching: components,\n                                         matchingPolicy: .nextTime,\n                                         repeatedTimePolicy: .first,\n                                         direction: .backward) else {\n    fatalError(\"*** unable to find the previous Monday. ***\")\n}\n```\n\nNext, create the quantity type and the statistics collection query. The following code creates the quantity type for step counts and then creates the query itself.\n\n```swift\nguard let quantityType = HKObjectType.quantityType(forIdentifier: .stepCount) else {\n    fatalError(\"*** Unable to create a step count type ***\")\n}\n\n\/\/ Create the query.\nlet query = HKStatisticsCollectionQuery(quantityType: quantityType,\n                                        quantitySamplePredicate: nil,\n                                        options: .cumulativeSum,\n                                        anchorDate: anchorDate,\n                                        intervalComponents: interval)\n```\n\n### Add Callback Handlers\n\nUnlike most other queries, you don’t set the callback block when you instantiate a statistics collection query. Instead, you can either set the initial result handler or the statistics update handler (or both) as needed for your app. In this case, the sample code just sets the initial results handler, letting it calculate statistics over the samples currently stored in HealthKit.\n\nIn your results handler, first check for and handle errors. Many [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKError\/Code] values indicate that you haven’t properly set up HealthKit. Always check HealthKit’s availability and request permission to read the specified data type before creating a query. For more information, see [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/setting-up-healthkit] and [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/authorizing-access-to-health-data].\n\nHowever, your app may need to explicitly check for some errors, depending on its needs. For example, if your app can run a query in the background, you need to check for and handle the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKError\/Code\/errorDatabaseInaccessible] error.\n\n```swift\n\/\/ Set the results handler.\nquery.initialResultsHandler = {\n    query, results, error in\n    \n    \/\/ Handle errors here.\n    if let error = error as? HKError {\n        switch (error.code) {\n        case .errorDatabaseInaccessible:\n            \/\/ HealthKit couldn't access the database because the device is locked.\n            return\n        default:\n            \/\/ Handle other HealthKit errors here.\n            return\n        }\n    }\n    \n    guard let statsCollection = results else {\n        \/\/ You should only hit this case if you have an unhandled error. Check for bugs \n        \/\/ in your code that creates the query, or explicitly handle the error.\n        assertionFailure(\"\")\n        return\n    }\n\n...\n```\n\nAfter you handle any errors, process the incoming statistics data, and then update your app. Be sure to dispatch code that updates the user interface to the [doc:\/\/com.apple.documentation\/documentation\/Dispatch\/DispatchQueue\/main] queue.\n\nThe following code calculates the start and end times for a 3-month window and then iterates over all the time intervals in that window. The statistics collection passes the enumeration block a statistics object for each time interval between the start and end dates. However, if the time interval doesn’t contain any samples, the provided statistics’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKStatistics\/sumQuantity()] method returns `nil`. Therefore, the sample must check to see whether it has a valid quantity. If it does, it adds the data; otherwise, it skips the time interval.\n\n```swift\n...\n    \n    let endDate = Date()\n    let threeMonthsAgo = DateComponents(month: -3)\n    \n    guard let startDate = calendar.date(byAdding: threeMonthsAgo, to: endDate) else {\n        fatalError(\"*** Unable to calculate the start date ***\")\n    }\n    \n    \/\/ Plot the weekly step counts over the past 3 months.\n    var weeklyData = MyWeeklyData()\n    \n    \/\/ Enumerate over all the statistics objects between the start and end dates.\n    statsCollection.enumerateStatistics(from: startDate, to: endDate)\n    { (statistics, stop) in\n        if let quantity = statistics.sumQuantity() {\n            let date = statistics.startDate\n            let value = quantity.doubleValue(for: .count())\n            \n            \/\/ Extract each week's data.\n            weeklyData.addWeek(date: date, stepCount: Int(value))\n        }\n    }\n    \n    \/\/ Dispatch to the main queue to update the UI.\n    DispatchQueue.main.async {\n        myUpdateGraph(weeklyData: weeklyData)\n    }\n}\n```\n\nFinally, execute the query using the HealthKit store.\n\n```swift\nhealthStore.execute(query)\n```\n\nSince the sample doesn’t provide an update results handler, when the initial results block finishes processing the data, the query stops automatically. If the sample had provided an update manager, the statistics collection query would continue to monitor the HealthKit store after it had generated the initial results.\n\n## Statistics\n\n- **Executing Statistical Queries**: Create and run statistical queries.\n- **HKStatisticsQueryDescriptor**: A query descriptor that calculates the minimum, maximum, average, or sum over a set of samples from the HealthKit store.\n- **HKStatisticsQuery**: A query that performs statistical calculations over a set of matching quantity samples, and returns the results.\n- **HKStatisticsCollectionQueryDescriptor**: A query descriptor that gathers a collection of statistics calculated over a series of fixed-length time intervals.\n- **HKStatisticsCollectionQuery**: A query that performs multiple statistics queries over a series of fixed-length time intervals.\n- **HKStatistics**: An object that represents the result of calculating the minimum, maximum, average, or sum over a set of samples from the HealthKit store.\n- **HKStatisticsCollection**: An object that manages a collection of statistics, representing the results calculated over separate time intervals.\n- **HKStatisticsOptions**: Options for specifying the statistic to calculate.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Create and run statistical queries.",
          "name" : "Executing Statistical Queries",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/executing-statistical-queries"
        },
        {
          "description" : "A query descriptor that calculates the minimum, maximum, average, or sum over a set of samples from the HealthKit store.",
          "name" : "HKStatisticsQueryDescriptor",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsQueryDescriptor"
        },
        {
          "description" : "A query that performs statistical calculations over a set of matching quantity samples, and returns the results.",
          "name" : "HKStatisticsQuery",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsQuery"
        },
        {
          "description" : "A query descriptor that gathers a collection of statistics calculated over a series of fixed-length time intervals.",
          "name" : "HKStatisticsCollectionQueryDescriptor",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsCollectionQueryDescriptor"
        },
        {
          "description" : "A query that performs multiple statistics queries over a series of fixed-length time intervals.",
          "name" : "HKStatisticsCollectionQuery",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsCollectionQuery"
        },
        {
          "description" : "An object that represents the result of calculating the minimum, maximum, average, or sum over a set of samples from the HealthKit store.",
          "name" : "HKStatistics",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatistics"
        },
        {
          "description" : "An object that manages a collection of statistics, representing the results calculated over separate time intervals.",
          "name" : "HKStatisticsCollection",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsCollection"
        },
        {
          "description" : "Options for specifying the statistic to calculate.",
          "name" : "HKStatisticsOptions",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKStatisticsOptions"
        }
      ],
      "title" : "Statistics"
    }
  ],
  "source" : "appleJSON",
  "title" : "Executing Statistics Collection Queries",
  "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/executing-statistics-collection-queries"
}