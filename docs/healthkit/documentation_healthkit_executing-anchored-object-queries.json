{
  "abstract" : "Create and run an anchored object query.",
  "codeExamples" : [
    {
      "code" : "guard let stepCountType = HKObjectType.quantityType(forIdentifier: .stepCount) else {\n    \/\/ This should never fail when using a defined constant.\n    fatalError(\"*** Unable to get the step count type ***\")\n}",
      "language" : "swift"
    },
    {
      "code" : "let query = HKAnchoredObjectQuery(type: stepCountType,\n                                  predicate: nil,\n                                  anchor: myAnchor,\n                                  limit: HKObjectQueryNoLimit)\n{ (query, samplesOrNil, deletedObjectsOrNil, newAnchor, errorOrNil) in\n    \n    guard let samples = samplesOrNil, let deletedObjects = deletedObjectsOrNil else {\n        \/\/ Properly handle the error.\n        return\n    }\n    \n    myAnchor = newAnchor\n    \n    for stepCountSample in samples {\n        \/\/ Process the new step count samples.\n    }\n    \n    for deletedStepCountSamples in deletedObjects {\n        \/\/ Process the deleted step count samples.\n    }\n\n    \/\/ The results come back on an anonymous background queue.\n    \/\/ Dispatch to the main queue before modifying the UI.\n    \n    DispatchQueue.main.async {\n        \/\/ Update the UI here.\n    }\n}",
      "language" : "swift"
    },
    {
      "code" : "store.execute(query)",
      "language" : "swift"
    },
    {
      "code" : "query.updateHandler = { (query, samplesOrNil, deletedObjectsOrNil, newAnchor, errorOrNil) in\n    guard let samples = samplesOrNil, let deletedObjects = deletedObjectsOrNil else {\n        \/\/ Properly handle the error.\n        return\n    }\n    \n    myAnchor = newAnchor\n    \n    for stepCountSample in samples {\n        \/\/ Process the step counts from the update.\n    }\n    \n    for deletedStepCountSamples in deletedObjects {\n        \/\/ Process the deleted step count samples from the update.\n    }\n}",
      "language" : "swift"
    }
  ],
  "contentHash" : "35c1c0c8069b3b1c7bd83dac15420c9d2c42d8743f1506c10c7127807f6b6a42",
  "crawledAt" : "2025-12-01T13:01:49Z",
  "id" : "8B23F138-466D-4A8B-B618-D571C4C2EEA4",
  "kind" : "article",
  "module" : "HealthKit",
  "overview" : "## Overview\n\nAnchored object queries return changes that occurred since the previous query. These queries can also continue running in a background queue, notifying your app about any updates to the specified samples.\n\n### Create an Anchored Object Query\n\nYou create an anchored object query by calling the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAnchoredObjectQuery\/init(type:predicate:anchor:limit:resultsHandler:)] initializer. Start by creating the type object for the desired samples. The following example creates a type object for step counts.\n\nNext, use the type object to build an anchored object query. The following example queries for all step count samples; it doesn’t use a predicate or limit to filter the results.\n\nAfter the query is instantiated, call the HealthKit store’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKHealthStore\/execute(_:)] method. This runs the query on an anonymous background queue. When the query is complete, it executes the results handler on the same background queue (but not necessarily the same thread).\n\nWhen you run the query, the system passes the current results to the results handler. If the `myAnchor` property is `nil`, the query returns all the step count data currently available in the HealthKit store. On subsequent runs, the code uses the anchor returned by the previous query. These queries return only the changes since the previous run.\n\n### Create a Long-Running Query\n\nOptionally, add an update handler to create a long-running query.\n\nNow, when you run the query, it continues to monitor the HealthKit store after returning the initial results. The system calls the update handler whenever it detects a change to the affected objects. Often, it’s more efficient to set up and run a single anchored object query than to run separate sample and observer queries. As a result, you may want to use anchored object queries, even when you aren’t using anchors to limit the results. In this case, set the anchor parameter to `nil`.",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/HealthKit\/executing-anchored-object-queries\ncrawled: 2025-12-01T13:01:49Z\n---\n\n# Executing Anchored Object Queries\n\n**Article**\n\nCreate and run an anchored object query.\n\n## Overview\n\nAnchored object queries return changes that occurred since the previous query. These queries can also continue running in a background queue, notifying your app about any updates to the specified samples.\n\n### Create an Anchored Object Query\n\nYou create an anchored object query by calling the [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKAnchoredObjectQuery\/init(type:predicate:anchor:limit:resultsHandler:)] initializer. Start by creating the type object for the desired samples. The following example creates a type object for step counts.\n\n```swift\nguard let stepCountType = HKObjectType.quantityType(forIdentifier: .stepCount) else {\n    \/\/ This should never fail when using a defined constant.\n    fatalError(\"*** Unable to get the step count type ***\")\n}\n```\n\nNext, use the type object to build an anchored object query. The following example queries for all step count samples; it doesn’t use a predicate or limit to filter the results.\n\n```swift\nlet query = HKAnchoredObjectQuery(type: stepCountType,\n                                  predicate: nil,\n                                  anchor: myAnchor,\n                                  limit: HKObjectQueryNoLimit)\n{ (query, samplesOrNil, deletedObjectsOrNil, newAnchor, errorOrNil) in\n    \n    guard let samples = samplesOrNil, let deletedObjects = deletedObjectsOrNil else {\n        \/\/ Properly handle the error.\n        return\n    }\n    \n    myAnchor = newAnchor\n    \n    for stepCountSample in samples {\n        \/\/ Process the new step count samples.\n    }\n    \n    for deletedStepCountSamples in deletedObjects {\n        \/\/ Process the deleted step count samples.\n    }\n\n    \/\/ The results come back on an anonymous background queue.\n    \/\/ Dispatch to the main queue before modifying the UI.\n    \n    DispatchQueue.main.async {\n        \/\/ Update the UI here.\n    }\n}\n```\n\nAfter the query is instantiated, call the HealthKit store’s [doc:\/\/com.apple.healthkit\/documentation\/HealthKit\/HKHealthStore\/execute(_:)] method. This runs the query on an anonymous background queue. When the query is complete, it executes the results handler on the same background queue (but not necessarily the same thread).\n\n```swift\nstore.execute(query)\n```\n\nWhen you run the query, the system passes the current results to the results handler. If the `myAnchor` property is `nil`, the query returns all the step count data currently available in the HealthKit store. On subsequent runs, the code uses the anchor returned by the previous query. These queries return only the changes since the previous run.\n\n### Create a Long-Running Query\n\nOptionally, add an update handler to create a long-running query.\n\n```swift\nquery.updateHandler = { (query, samplesOrNil, deletedObjectsOrNil, newAnchor, errorOrNil) in\n    guard let samples = samplesOrNil, let deletedObjects = deletedObjectsOrNil else {\n        \/\/ Properly handle the error.\n        return\n    }\n    \n    myAnchor = newAnchor\n    \n    for stepCountSample in samples {\n        \/\/ Process the step counts from the update.\n    }\n    \n    for deletedStepCountSamples in deletedObjects {\n        \/\/ Process the deleted step count samples from the update.\n    }\n}\n```\n\nNow, when you run the query, it continues to monitor the HealthKit store after returning the initial results. The system calls the update handler whenever it detects a change to the affected objects. Often, it’s more efficient to set up and run a single anchored object query than to run separate sample and observer queries. As a result, you may want to use anchored object queries, even when you aren’t using anchors to limit the results. In this case, set the anchor parameter to `nil`.\n\n## Creating Anchored Object Queries\n\n- **init(type:predicate:anchor:limit:resultsHandler:)**: Initializes a new anchored object query.\n- **init(queryDescriptors:anchor:limit:resultsHandler:)**: Creates an anchored object query that matches any of the query descriptors you provided.\n- **HKObjectQueryNoLimit**: A value indicating that the query returns all the matching samples in the HealthKit store.\n- **init(type:predicate:anchor:limit:completionHandler:)**: Initializes a new anchored object query.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Initializes a new anchored object query.",
          "name" : "init(type:predicate:anchor:limit:resultsHandler:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKAnchoredObjectQuery\/init(type:predicate:anchor:limit:resultsHandler:)"
        },
        {
          "description" : "Creates an anchored object query that matches any of the query descriptors you provided.",
          "name" : "init(queryDescriptors:anchor:limit:resultsHandler:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKAnchoredObjectQuery\/init(queryDescriptors:anchor:limit:resultsHandler:)"
        },
        {
          "description" : "A value indicating that the query returns all the matching samples in the HealthKit store.",
          "name" : "HKObjectQueryNoLimit",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKObjectQueryNoLimit"
        },
        {
          "description" : "Initializes a new anchored object query.",
          "name" : "init(type:predicate:anchor:limit:completionHandler:)",
          "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/HKAnchoredObjectQuery\/init(type:predicate:anchor:limit:completionHandler:)"
        }
      ],
      "title" : "Creating Anchored Object Queries"
    }
  ],
  "source" : "appleJSON",
  "title" : "Executing Anchored Object Queries",
  "url" : "https:\/\/developer.apple.com\/documentation\/HealthKit\/executing-anchored-object-queries"
}