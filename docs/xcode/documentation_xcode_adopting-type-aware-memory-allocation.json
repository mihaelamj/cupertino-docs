{
  "abstract" : "Reduce the opportunities to treat pointers as data in your code.",
  "codeExamples" : [
    {
      "code" : "#if defined(_MALLOC_TYPE_ENABLED) && _MALLOC_TYPE_ENABLED\n\n\/\/ Declare the type-aware variant of your wrapper function.\nvoid *my_malloc_typed(size_t size, malloc_type_id_t type_id);\n\n\/\/ Declare your wrapper function, and annotate it with a reference to the type-aware variant.\nvoid *my_malloc(size_t size) _MALLOC_TYPED(my_malloc_typed, 1);\n\n#else\n\n\/\/ Declare your wrapper function without any annotation.\nvoid *my_malloc(size_t size);\n\n#endif",
      "language" : "c"
    },
    {
      "code" : "void *my_malloc_typed(size_t size, malloc_type_id_t type_id) {\n  \/\/ Implement the custom logic for your wrapper function.\n\n  return malloc_type_malloc(size, type_id);\n}",
      "language" : "c"
    }
  ],
  "contentHash" : "8dcdf330e2d8d93069d967432111d339c6e0dab59104d8e3eb6294b79a855dd1",
  "crawledAt" : "2025-12-03T03:55:02Z",
  "id" : "E24D6EDE-6D5D-4F75-B520-1362429539BC",
  "kind" : "article",
  "language" : "swift",
  "overview" : "## Overview\n\nThe compiler supports type-aware memory allocations, which track the data types you allocate memory for, and returns pointers to memory in different regions for different data types. The typed allocator generates a descriptor for any type of data structure you allocate in your code, for example, a C `struct` or a C++ `class`. When you allocate memory for storing a particular type of data structure, the compiler computes the type’s descriptor and returns memory from a zone dedicated to containing memory with that descriptor.\n\nBecause the system records that the memory zone containing the pointer is associated with the specified type, it can isolate allocations for memory regions that contain pointers from allocations for pure-data regions.\n\nWhen you enable the type-aware memory allocator, the compiler automatically rewrites calls to `malloc`, `calloc`, `realloc`, `posix_memalign`, related functions, and the C++ `new` operator, to use type-aware equivalents.\n\n### Enable the type-aware memory allocator for your target\n\nXcode automatically configures your target to use the type-aware memory allocator, in addition to other hardening settings, when you add the Enhanced Security capability. For more information, see [doc:\/\/com.apple.Xcode\/documentation\/Xcode\/enabling-enhanced-security-for-your-app].\n\nTo enable the type-aware memory allocator without adding the Enhanced Security capability, in your target:\n\n### Make type-aware memory allocations\n\nYou need to call the type-aware version of memory-allocation functions anywhere you use runtime information to determine type before allocating memory. For example, if your app includes a runtime library for a programming language that uses runtime information to determine the type of a pointer. To call the type-aware version of memory-allocation functions yourself, prefix the function name with `malloc_type_`. For example, `malloc` becomes `malloc_type_malloc`.\n\nThe `malloc_type_` functions take an additional parameter compared with the regular allocator functions, that’s the type descriptor of the type you allocate. Calculate the type descriptor for a given type by constructing a `malloc_type_descriptor_v0_t` that describes the type, and reading its `type_id` member value.\n\nIf you use `union` types, avoid designing a type that uses the same location for either a pointer or for data, as the typed allocator can’t protect that memory.\n\n### Create type-aware allocator wrappers\n\nIf your project includes wrapper functions that call the system’s memory-allocation functions, consider whether you can remove the wrappers and call the memory-allocation functions directly, and benefit from the compiler’s automatic rewrites to use typed allocators. If you can’t remove your wrapper functions, write type-aware variants of the wrapper functions and use the `_MALLOC_TYPED` macro to annotate your existing wrapper functions with references to their type-aware variants. The macro takes two parameters:\n\nFor example:\n\nIn your wrapper function’s type-aware variant, return a pointer to memory that you allocate using the `malloc_type_` library function variants:",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Xcode\/adopting-type-aware-memory-allocation\ncrawled: 2025-12-03T03:55:02Z\n---\n\n# Adopting type-aware memory allocation\n\n**Article**\n\nReduce the opportunities to treat pointers as data in your code.\n\n## Overview\n\nThe compiler supports type-aware memory allocations, which track the data types you allocate memory for, and returns pointers to memory in different regions for different data types. The typed allocator generates a descriptor for any type of data structure you allocate in your code, for example, a C `struct` or a C++ `class`. When you allocate memory for storing a particular type of data structure, the compiler computes the type’s descriptor and returns memory from a zone dedicated to containing memory with that descriptor.\n\nBecause the system records that the memory zone containing the pointer is associated with the specified type, it can isolate allocations for memory regions that contain pointers from allocations for pure-data regions.\n\nWhen you enable the type-aware memory allocator, the compiler automatically rewrites calls to `malloc`, `calloc`, `realloc`, `posix_memalign`, related functions, and the C++ `new` operator, to use type-aware equivalents.\n\n### Enable the type-aware memory allocator for your target\n\nXcode automatically configures your target to use the type-aware memory allocator, in addition to other hardening settings, when you add the Enhanced Security capability. For more information, see [doc:\/\/com.apple.Xcode\/documentation\/Xcode\/enabling-enhanced-security-for-your-app].\n\nTo enable the type-aware memory allocator without adding the Enhanced Security capability, in your target:\n\n- Add the [doc:\/\/com.apple.documentation\/documentation\/BundleResources\/Entitlements\/com.apple.security.hardened-process.hardened-heap] entitlement with the value `YES`\n- Set the `CLANG_ENABLE_C_TYPED_ALLOCATOR_SUPPORT` build setting with the value `YES`\n- Set the `CLANG_ENABLE_CPLUSPLUS_TYPED_ALLOCATOR_SUPPORT` build setting with the value to `YES`\n\n### Make type-aware memory allocations\n\nYou need to call the type-aware version of memory-allocation functions anywhere you use runtime information to determine type before allocating memory. For example, if your app includes a runtime library for a programming language that uses runtime information to determine the type of a pointer. To call the type-aware version of memory-allocation functions yourself, prefix the function name with `malloc_type_`. For example, `malloc` becomes `malloc_type_malloc`.\n\nThe `malloc_type_` functions take an additional parameter compared with the regular allocator functions, that’s the type descriptor of the type you allocate. Calculate the type descriptor for a given type by constructing a `malloc_type_descriptor_v0_t` that describes the type, and reading its `type_id` member value.\n\nIf you use `union` types, avoid designing a type that uses the same location for either a pointer or for data, as the typed allocator can’t protect that memory.\n\n### Create type-aware allocator wrappers\n\nIf your project includes wrapper functions that call the system’s memory-allocation functions, consider whether you can remove the wrappers and call the memory-allocation functions directly, and benefit from the compiler’s automatic rewrites to use typed allocators. If you can’t remove your wrapper functions, write type-aware variants of the wrapper functions and use the `_MALLOC_TYPED` macro to annotate your existing wrapper functions with references to their type-aware variants. The macro takes two parameters:\n\n- The name of the type-aware wrapper function\n- The index, in the original function’s argument list, of the argument developers use to pass the allocation’s size (the first argument is at position `1`)\n\nFor example:\n\n```c\n#if defined(_MALLOC_TYPE_ENABLED) && _MALLOC_TYPE_ENABLED\n\n\/\/ Declare the type-aware variant of your wrapper function.\nvoid *my_malloc_typed(size_t size, malloc_type_id_t type_id);\n\n\/\/ Declare your wrapper function, and annotate it with a reference to the type-aware variant.\nvoid *my_malloc(size_t size) _MALLOC_TYPED(my_malloc_typed, 1);\n\n#else\n\n\/\/ Declare your wrapper function without any annotation.\nvoid *my_malloc(size_t size);\n\n#endif\n```\n\nIn your wrapper function’s type-aware variant, return a pointer to memory that you allocate using the `malloc_type_` library function variants:\n\n```c\nvoid *my_malloc_typed(size_t size, malloc_type_id_t type_id) {\n  \/\/ Implement the custom logic for your wrapper function.\n\n  return malloc_type_malloc(size, type_id);\n}\n```\n\n## Security and privacy\n\n- **Verifying the origin of your XCFrameworks**: Discover who signed a framework, and take action when that changes.\n- **Enabling enhanced security for your app**: Detect out-of-bounds memory access, use of freed memory, and other potential vulnerabilities.\n- **Creating enhanced security helper extensions**: Reduce opportunities for an attacker to target your app through its extensions.\n- **Conforming to Mach IPC security restrictions**: Avoid crashes and potentially insecure situations associated with Mach messages.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Discover who signed a framework, and take action when that changes.",
          "name" : "Verifying the origin of your XCFrameworks",
          "url" : "https:\/\/developer.apple.com\/documentation\/Xcode\/verifying-the-origin-of-your-xcframeworks"
        },
        {
          "description" : "Detect out-of-bounds memory access, use of freed memory, and other potential vulnerabilities.",
          "name" : "Enabling enhanced security for your app",
          "url" : "https:\/\/developer.apple.com\/documentation\/Xcode\/enabling-enhanced-security-for-your-app"
        },
        {
          "description" : "Reduce opportunities for an attacker to target your app through its extensions.",
          "name" : "Creating enhanced security helper extensions",
          "url" : "https:\/\/developer.apple.com\/documentation\/Xcode\/creating-enhanced-security-helper-extensions"
        },
        {
          "description" : "Avoid crashes and potentially insecure situations associated with Mach messages.",
          "name" : "Conforming to Mach IPC security restrictions",
          "url" : "https:\/\/developer.apple.com\/documentation\/Xcode\/conforming-to-mach-ipc-security-restrictions"
        }
      ],
      "title" : "Security and privacy"
    }
  ],
  "source" : "appleJSON",
  "title" : "Adopting type-aware memory allocation",
  "url" : "https:\/\/developer.apple.com\/documentation\/Xcode\/adopting-type-aware-memory-allocation"
}