{
  "abstract" : "Discover how Metal executes commands on a GPU.",
  "codeExamples" : [

  ],
  "contentHash" : "38269e2ee7d67c152e265befece874a7ce04decad7ede58ab04236b15e052a3f",
  "crawledAt" : "2025-12-01T17:57:24Z",
  "id" : "1866B56E-1835-4C9B-A10F-8BE9F3452069",
  "kind" : "article",
  "module" : "Metal",
  "overview" : "## Overview\n\nIn Metal, you send commands to the GPU so it can perform work on your behalf. A command performs the drawing, parallel computation, and resource management work your app requires.\n\nThe relationship between Metal apps and the GPU on a device is a client\/server model where your app is the client and the GPU is the server. You make requests by sending commands to the GPU that you encapsulate in a command buffer and then add to a command queue. After processing the commands, the GPU notifies your app when it’s ready for more work.\n\n\n\nThe order that you place commands in command buffers, then enqueue and commit command buffers, affects the perceived order in which Metal executes your commands.\n\nThe following sections explain how to set up a command structure to produce the results you want. Some objects you create once and use throughout your app, and others you create specifically to execute a set of commands.\n\n### Create expensive shared objects during initialization\n\nCreate objects that are expensive to allocate during initialization, not in time-critical code paths. Objects that you can share in your code are command queues, pipelines, buffers, and textures. After you initialize these objects, they’re fast to reuse.\n\n#### Make a Command Queue\n\nTo make a command queue, call the device’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/makeCommandQueue()] function.\n\nThen use the same command queue throughout your app to hold command buffers. The figure below illustrates the command queue that contains command buffers:\n\n\n\n#### Make One or More Pipeline Objects\n\nA *pipeline object* tells Metal how to process your commands. The pipeline object encapsulates functions that you write in the Metal shading language. To use a pipeline in your Metal workflow, follow these steps:\n\nMetal doesn’t perform your draw or compute calls immediately. Instead, you use an encoder object to insert commands that encapsulate those calls into your command buffer. After you commit the command buffer, Metal sends it to the GPU and uses the active pipeline object to process the commands.\n\nThe figure below illustrates the active pipeline on the GPU that contains your custom shader code that processes commands:\n\n\n\n### Issue commands to the GPU\n\nTo execute commands on the GPU, follow this process:\n\nIf you’re performing animation as part of a rendering loop, do this for each frame of the animation. You also follow this process to execute one-off image processing, or machine learning tasks.\n\n#### Create a Command Buffer\n\nCreate a command buffer by calling [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandQueue\/makeCommandBuffer()] on the command queue.\n\nFor single-threaded apps, create a single command buffer containing the commands. The figure below illustrates the command buffer’s relationship to the commands it contains:\n\n\n\n#### Add Commands to the Command Buffer\n\nWhen you call task-specific functions on an encoder object — like draws or compute operations — the encoder places commands corresponding to those calls in the command buffer. The encoder inserts the commands into the command buffer, including everything the GPU needs to process the task at runtime.\n\nThe figure below illustrates a command encoder inserting commands into a command buffer when the app makes a draw call:\n\n\n\nYou encode actual commands with concrete subclasses of [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandEncoder], depending on your task. For example, use [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderCommandEncoder] to issue render commands, and [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputeCommandEncoder] to issue parallel computation commands. For a complete list of subclasses, see [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandEncoder].\n\nFor a complete rendering example, see [doc:\/\/com.apple.metal\/documentation\/Metal\/drawing-a-triangle-with-metal-4]. For a complete parallel processing example, see [doc:\/\/com.apple.metal\/documentation\/Metal\/processing-a-texture-in-a-compute-function].\n\n#### Commit a Command Buffer\n\nTo submit your commands to run on the GPU, commit the command buffer to the GPU.\n\nCommitting a command buffer doesn’t run its commands immediately. Instead, Metal schedules the buffer’s commands to run only after you commit prior command buffers that are waiting in the queue. If you don’t explicitly enqueue a command buffer, Metal does that for you when you commit the buffer.\n\nYou can’t reuse a buffer after you commit it, but you can receive notifications when Metal schedules and completes the commands, or you can query the buffer’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/status]. To receive callbacks during this process, use the [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer] [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/addScheduledHandler(_:)] and [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/addCompletedHandler(_:)] methods.\n\nAs much as possible, the perceived order in which Metal executes the commands is the same as the way you order them. Although Metal might reorder some of your commands before processing them, this usually only occurs when there’s a performance gain and no other perceivable impact.",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Metal\/setting-up-a-command-structure\ncrawled: 2025-12-01T17:57:24Z\n---\n\n# Setting up a command structure\n\n**Article**\n\nDiscover how Metal executes commands on a GPU.\n\n## Overview\n\nIn Metal, you send commands to the GPU so it can perform work on your behalf. A command performs the drawing, parallel computation, and resource management work your app requires.\n\nThe relationship between Metal apps and the GPU on a device is a client\/server model where your app is the client and the GPU is the server. You make requests by sending commands to the GPU that you encapsulate in a command buffer and then add to a command queue. After processing the commands, the GPU notifies your app when it’s ready for more work.\n\n\n\nThe order that you place commands in command buffers, then enqueue and commit command buffers, affects the perceived order in which Metal executes your commands.\n\nThe following sections explain how to set up a command structure to produce the results you want. Some objects you create once and use throughout your app, and others you create specifically to execute a set of commands.\n\n### Create expensive shared objects during initialization\n\nCreate objects that are expensive to allocate during initialization, not in time-critical code paths. Objects that you can share in your code are command queues, pipelines, buffers, and textures. After you initialize these objects, they’re fast to reuse.\n\n#### Make a Command Queue\n\nTo make a command queue, call the device’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/makeCommandQueue()] function.\n\n\n\nThen use the same command queue throughout your app to hold command buffers. The figure below illustrates the command queue that contains command buffers:\n\n\n\n#### Make One or More Pipeline Objects\n\nA *pipeline object* tells Metal how to process your commands. The pipeline object encapsulates functions that you write in the Metal shading language. To use a pipeline in your Metal workflow, follow these steps:\n\n1. Write Metal shader functions that process your data.\n2. Create a pipeline object that contains your shaders.\n3. Set the state of the render or compute pipeline.\n4. Make draw or compute calls.\n\nMetal doesn’t perform your draw or compute calls immediately. Instead, you use an encoder object to insert commands that encapsulate those calls into your command buffer. After you commit the command buffer, Metal sends it to the GPU and uses the active pipeline object to process the commands.\n\nThe figure below illustrates the active pipeline on the GPU that contains your custom shader code that processes commands:\n\n\n\n### Issue commands to the GPU\n\nTo execute commands on the GPU, follow this process:\n\n1. Create a command buffer from a command queue.\n2. Create a command encoder using the command buffer.\n3. Add the commands to the command buffer using the command encoder.\n4. Get callbacks when the GPU schedules and executes the commands by setting completion handlers.\n5. Commit the command buffer.\n\nIf you’re performing animation as part of a rendering loop, do this for each frame of the animation. You also follow this process to execute one-off image processing, or machine learning tasks.\n\n#### Create a Command Buffer\n\nCreate a command buffer by calling [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandQueue\/makeCommandBuffer()] on the command queue.\n\n\n\nFor single-threaded apps, create a single command buffer containing the commands. The figure below illustrates the command buffer’s relationship to the commands it contains:\n\n\n\n#### Add Commands to the Command Buffer\n\nWhen you call task-specific functions on an encoder object — like draws or compute operations — the encoder places commands corresponding to those calls in the command buffer. The encoder inserts the commands into the command buffer, including everything the GPU needs to process the task at runtime.\n\nThe figure below illustrates a command encoder inserting commands into a command buffer when the app makes a draw call:\n\n\n\nYou encode actual commands with concrete subclasses of [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandEncoder], depending on your task. For example, use [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderCommandEncoder] to issue render commands, and [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputeCommandEncoder] to issue parallel computation commands. For a complete list of subclasses, see [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandEncoder].\n\nFor a complete rendering example, see [doc:\/\/com.apple.metal\/documentation\/Metal\/drawing-a-triangle-with-metal-4]. For a complete parallel processing example, see [doc:\/\/com.apple.metal\/documentation\/Metal\/processing-a-texture-in-a-compute-function].\n\n#### Commit a Command Buffer\n\nTo submit your commands to run on the GPU, commit the command buffer to the GPU.\n\n\n\nCommitting a command buffer doesn’t run its commands immediately. Instead, Metal schedules the buffer’s commands to run only after you commit prior command buffers that are waiting in the queue. If you don’t explicitly enqueue a command buffer, Metal does that for you when you commit the buffer.\n\nYou can’t reuse a buffer after you commit it, but you can receive notifications when Metal schedules and completes the commands, or you can query the buffer’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/status]. To receive callbacks during this process, use the [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer] [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/addScheduledHandler(_:)] and [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCommandBuffer\/addCompletedHandler(_:)] methods.\n\nAs much as possible, the perceived order in which Metal executes the commands is the same as the way you order them. Although Metal might reorder some of your commands before processing them, this usually only occurs when there’s a performance gain and no other perceivable impact.\n\n## Submitting work to a GPU with Metal\n\n- **MTLCommandQueue**: An instance you use to create, submit, and schedule command buffers to a specific GPU device to run the commands within those buffers.\n- **MTLCommandQueueDescriptor**: A configuration that customizes the behavior for a new command queue.\n- **MTLCommandBuffer**: A container that stores a sequence of GPU commands that you encode into it.\n- **MTLCommandBufferDescriptor**: A configuration that customizes the behavior for a new command buffer.\n- **MTLCommandBufferError**: The command buffer error codes that indicate why the GPU doesn’t finish executing a command buffer.\n- **MTLCommandEncoder**: An encoder that writes GPU commands into a command buffer.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "An instance you use to create, submit, and schedule command buffers to a specific GPU device to run the commands within those buffers.",
          "name" : "MTLCommandQueue",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandQueue"
        },
        {
          "description" : "A configuration that customizes the behavior for a new command queue.",
          "name" : "MTLCommandQueueDescriptor",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandQueueDescriptor"
        },
        {
          "description" : "A container that stores a sequence of GPU commands that you encode into it.",
          "name" : "MTLCommandBuffer",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandBuffer"
        },
        {
          "description" : "A configuration that customizes the behavior for a new command buffer.",
          "name" : "MTLCommandBufferDescriptor",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandBufferDescriptor"
        },
        {
          "description" : "The command buffer error codes that indicate why the GPU doesn’t finish executing a command buffer.",
          "name" : "MTLCommandBufferError",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandBufferError-swift.struct"
        },
        {
          "description" : "An encoder that writes GPU commands into a command buffer.",
          "name" : "MTLCommandEncoder",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCommandEncoder"
        }
      ],
      "title" : "Submitting work to a GPU with Metal"
    }
  ],
  "source" : "appleJSON",
  "title" : "Setting up a command structure",
  "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/setting-up-a-command-structure"
}