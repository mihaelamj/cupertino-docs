{
  "abstract" : "Build a Metal dynamic library from the command line, allowing for runtime loading of shared shaders.",
  "codeExamples" : [
    {
      "code" : "% xcrun -sdk macosx metal -dynamiclib utilities.metal -o libUtility.ir.metallib -install_name libUtility.metallib",
      "language" : "shell"
    },
    {
      "code" : "% xcrun -sdk macosx metal-tt libUtility.metalir.metallib -o libUtility.metallib $(xcrun -sdk macosx metal-config --native-arch-flags --gpu-family=metal3)",
      "language" : "shell"
    },
    {
      "code" : "% # Uncomment the next line to rename the library if you need to.\n% # mv libUtility.metalir.metallib libUtility.metallib\n% xcrun -sdk macosx metal shaders.ir -o shaders.metallib -lUtility -L .\/",
      "language" : "shell"
    }
  ],
  "contentHash" : "719092c65eb3b8172b2ea6872e9f804266eed0347a2ff7010c2296a40533db1a",
  "crawledAt" : "2025-12-03T14:49:46Z",
  "id" : "7257E77F-10BC-43C3-A466-67A9FBB2BCA2",
  "kind" : "article",
  "language" : "swift",
  "module" : "Metal",
  "overview" : "## Overview\n\nWhen you share a set of utility functions between multiple Metal libraries, static linking at compile time includes those functions in all of your libraries. This causes libraries to increase in size because each Metal library includes duplicate code for the utility functions. Metal also compiles individual, identical versions of your utilites for each library, causing longer shader compilation times.\n\nMetal offers dynamic libraries with runtime loading to solve these problems — you compile your utilities into a dynamic library and link other Metal libraries to it, giving a single source for your utility functions.\n\nThis article tells you how to build a dynamic library from the command line with the Metal compiler, add binary archives, and then link your dynamic library to another Metal library. Your app then loads your linked library at runtime. This article uses the following filenames in code examples:\n\nFor instructions on compiling an intermediate representation for Metal, see [doc:\/\/com.apple.metal\/documentation\/Metal\/building-a-shader-library-by-precompiling-source-files]. For an example of an app that builds and links dynamic libraries at runtime, see [doc:\/\/com.apple.metal\/documentation\/Metal\/creating-a-metal-dynamic-library].\n\n### Compile shaders to a dynamic library\n\nStart by compiling your utility functions to a dynamic library. Use the `metal` command-line tool, adding both the `-dynamiclib` and `-install_name` options. The `-dynamiclib` flag builds the output as a dynamic library, and `-install_name` is the library name that the linker uses to resolve the library. The following compiler invocation builds `utilities.metal` to a dynamic library `libUtility.ir.metallib`, where you link the library as `Utility`:\n\n### Add binary archives to your dynamic library optionally\n\nBinary archives are prebuilt shader functions for GPUs you specify at compile time. Use binary archives when you prefer to make the tradeoff of distributing larger files for your app while avoiding the cost of compiling shaders from Metal IR at runtime. For more information on binary archives, see [doc:\/\/com.apple.metal\/documentation\/Metal\/metal-binary-archives].\n\nThe Metal translator allows you to create a dynamic library with GPU-specific binaries alongside the Metal IR slices. The example below provides the command-line arguments that `metal-tt` uses to add Metal 3 binaries to `libUtility.metalir.metallib`. Then, the combined output writes to `libUtility.metallib`.\n\nFor more information on `metal-config`, run `man metal-config` in Terminal.\n\nFor more information about the Metal translator and how you can customize which binaries to build from a Metal IR file, see [doc:\/\/com.apple.metal\/documentation\/Metal\/creating-binary-archives-from-device-built-pipeline-state-objects] and [doc:\/\/com.apple.metal\/documentation\/Metal\/compiling-binary-archives-from-a-custom-configuration-script].\n\n### Link utility shaders to your Metal library\n\nPrelinking dynamic libraries to your other libraries avoids some runtime costs associated with resolving the symbols to load from your dynamic library. When you’re compiling your final Metal libraries to ship, use the `-L` and `-l` linker options with the `metal` command-line tool. The `-l` option provides the names of libraries to link to, and `-L` provides custom library search paths. The following code example demonstrates linking an intermediate representation `shaders.ir` with the `Utilities` library that you compile from the previous step. If you skip compiling binaries into your dynamic library, rename `libUtility.metalir.metallib` to `libUtility.metallib`.\n\nAdd both `shaders.metallib` and `libUtility.metallib` to your Xcode project as resources. For your dynamic library to load correctly if you link it from the command line, place it at a location in your app’s resources corresponding to the path that you set for the `-L` argument. In this example, put `shaders.metallib` and l`ibUtility.metallib` in the same directory in a resource bundle.\n\n### Load dynamic libraries in your app\n\nUse the [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/makeDynamicLibrary(url:)] method in your app to load your Metal dynamic library, and then add it to a pipeline descriptor calling the shader functions in your other Metal libraries. The following code example loads a dynamic library and creates an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputePipelineDescriptor] that includes it as a library to load:",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Metal\/compiling-and-linking-metal-dynamic-libraries\ncrawled: 2025-12-03T14:49:46Z\n---\n\n# Compiling and linking Metal dynamic libraries\n\n**Article**\n\nBuild a Metal dynamic library from the command line, allowing for runtime loading of shared shaders.\n\n## Overview\n\nWhen you share a set of utility functions between multiple Metal libraries, static linking at compile time includes those functions in all of your libraries. This causes libraries to increase in size because each Metal library includes duplicate code for the utility functions. Metal also compiles individual, identical versions of your utilites for each library, causing longer shader compilation times.\n\nMetal offers dynamic libraries with runtime loading to solve these problems — you compile your utilities into a dynamic library and link other Metal libraries to it, giving a single source for your utility functions.\n\nThis article tells you how to build a dynamic library from the command line with the Metal compiler, add binary archives, and then link your dynamic library to another Metal library. Your app then loads your linked library at runtime. This article uses the following filenames in code examples:\n\n- `utilities.metal`, a metal source file that contains your utility functions\n- `shaders.ir`, an intermediate representation from the Metal compiler containing shaders that call functions in `utilities.metal`\n\nFor instructions on compiling an intermediate representation for Metal, see [doc:\/\/com.apple.metal\/documentation\/Metal\/building-a-shader-library-by-precompiling-source-files]. For an example of an app that builds and links dynamic libraries at runtime, see [doc:\/\/com.apple.metal\/documentation\/Metal\/creating-a-metal-dynamic-library].\n\n### Compile shaders to a dynamic library\n\nStart by compiling your utility functions to a dynamic library. Use the `metal` command-line tool, adding both the `-dynamiclib` and `-install_name` options. The `-dynamiclib` flag builds the output as a dynamic library, and `-install_name` is the library name that the linker uses to resolve the library. The following compiler invocation builds `utilities.metal` to a dynamic library `libUtility.ir.metallib`, where you link the library as `Utility`:\n\n```shell\n% xcrun -sdk macosx metal -dynamiclib utilities.metal -o libUtility.ir.metallib -install_name libUtility.metallib\n```\n\n\n\n### Add binary archives to your dynamic library optionally\n\nBinary archives are prebuilt shader functions for GPUs you specify at compile time. Use binary archives when you prefer to make the tradeoff of distributing larger files for your app while avoiding the cost of compiling shaders from Metal IR at runtime. For more information on binary archives, see [doc:\/\/com.apple.metal\/documentation\/Metal\/metal-binary-archives].\n\nThe Metal translator allows you to create a dynamic library with GPU-specific binaries alongside the Metal IR slices. The example below provides the command-line arguments that `metal-tt` uses to add Metal 3 binaries to `libUtility.metalir.metallib`. Then, the combined output writes to `libUtility.metallib`.\n\n```shell\n% xcrun -sdk macosx metal-tt libUtility.metalir.metallib -o libUtility.metallib $(xcrun -sdk macosx metal-config --native-arch-flags --gpu-family=metal3)\n```\n\nFor more information on `metal-config`, run `man metal-config` in Terminal.\n\nFor more information about the Metal translator and how you can customize which binaries to build from a Metal IR file, see [doc:\/\/com.apple.metal\/documentation\/Metal\/creating-binary-archives-from-device-built-pipeline-state-objects] and [doc:\/\/com.apple.metal\/documentation\/Metal\/compiling-binary-archives-from-a-custom-configuration-script].\n\n### Link utility shaders to your Metal library\n\nPrelinking dynamic libraries to your other libraries avoids some runtime costs associated with resolving the symbols to load from your dynamic library. When you’re compiling your final Metal libraries to ship, use the `-L` and `-l` linker options with the `metal` command-line tool. The `-l` option provides the names of libraries to link to, and `-L` provides custom library search paths. The following code example demonstrates linking an intermediate representation `shaders.ir` with the `Utilities` library that you compile from the previous step. If you skip compiling binaries into your dynamic library, rename `libUtility.metalir.metallib` to `libUtility.metallib`.\n\n```shell\n% # Uncomment the next line to rename the library if you need to.\n% # mv libUtility.metalir.metallib libUtility.metallib\n% xcrun -sdk macosx metal shaders.ir -o shaders.metallib -lUtility -L .\/\n```\n\nAdd both `shaders.metallib` and `libUtility.metallib` to your Xcode project as resources. For your dynamic library to load correctly if you link it from the command line, place it at a location in your app’s resources corresponding to the path that you set for the `-L` argument. In this example, put `shaders.metallib` and l`ibUtility.metallib` in the same directory in a resource bundle.\n\n### Load dynamic libraries in your app\n\nUse the [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/makeDynamicLibrary(url:)] method in your app to load your Metal dynamic library, and then add it to a pipeline descriptor calling the shader functions in your other Metal libraries. The following code example loads a dynamic library and creates an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputePipelineDescriptor] that includes it as a library to load:\n\n\n\n## Working with Metal dynamic libraries\n\n- **Creating a Metal dynamic library**: Compile a library of shaders and write it to a file as a dynamically linked library.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Compile a library of shaders and write it to a file as a dynamically linked library.",
          "name" : "Creating a Metal dynamic library",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/creating-a-metal-dynamic-library"
        }
      ],
      "title" : "Working with Metal dynamic libraries"
    }
  ],
  "source" : "appleJSON",
  "title" : "Compiling and linking Metal dynamic libraries",
  "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/compiling-and-linking-metal-dynamic-libraries"
}