{
  "abstract" : "Retrieve a GPU’s counter data at a time the GPU supports.",
  "codeExamples" : [
    {
      "code" : "    ...\n    sampleAttachment.sampleBuffer = self.counterSampleBuffer;\n    sampleAttachment.startOfVertexSampleIndex = MTLCounterDontSample;\n    sampleAttachment.endOfVertexSampleIndex = MTLCounterDontSample;\n    sampleAttachment.startOfFragmentSampleIndex = 2;\n    sampleAttachment.endOfFragmentSampleIndex = 3;\n}",
      "language" : "swift"
    }
  ],
  "contentHash" : "ebb5e8fc6216c336d531d38e78a2fb6fdac47902a602e96e02549a2c8122539e",
  "crawledAt" : "2025-12-02T19:54:45Z",
  "id" : "2F094566-95A5-4558-A826-00746AAF2F99",
  "kind" : "article",
  "language" : "swift",
  "module" : "Metal",
  "overview" : "## Overview\n\nYou can sample a GPU device’s performance counter data at different times, including:\n\nTypically, a GPU supports one of these boundary types. For example, Apple silicon supports sampling at the stage boundary because it processes fragments after processing every primitive for a render pass. However, a typical immediate-mode GPU supports sampling between commands.\n\nBefore you can sample a GPU counter, implement the following prerequisite steps:\n\nThe sections below explain how to identify when you can sample a GPU’s counters, and how to encode commands to retrieve their data.\n\nEach GPU vendor defines its own private data format for its counter sample buffers, which means your app can’t read the contents of each buffer directly. Instead, your app can transform the data from the vendor’s internal format to the standard Metal formats by *resolving* each sample buffer. See [doc:\/\/com.apple.metal\/documentation\/Metal\/converting-a-gpus-counter-data-into-a-readable-format] for the next steps that resolve the data within a counter sample buffer.\n\n### Check which boundaries a GPU supports\n\nYou can inspect a GPU device instance to see whether it supports a specific sample boundary by calling its [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/supportsCounterSampling(_:)] method with each [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint] case.\n\nThis method checks for multiple sample boundaries and returns those the GPU supports in an array.\n\n### Sample counters at stage boundaries\n\nFor a GPU device that can sample counters at stage boundaries ( [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atStageBoundary]), you can sample its counters between the stages of a pass. When the GPU starts or finishes a stage, it samples the counters and copies the results into a counter sample buffer.\n\nYou tell the GPU which counters to sample by configuring a pass descriptor’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputePassDescriptor\/sampleBufferAttachments] property. For example, you can sample the timestamp counters before and after the vertex and fragment stages by configuring an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderPassDescriptor] instance’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderPassDescriptor\/sampleBufferAttachments] property.\n\nEach index value tells the GPU where to put a specific counter value within a counter sample buffer. You can skip specific counters by setting an index to [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterDontSample]. For example, you can alter the code example above so that the GPU only samples before and after a fragment stage.\n\nThis example still stores the fragment counter data in the third and fourth positions within the counter sample buffer (at indexes 2 and 3, respectively). However, it doesn’t sample the vertex stage timestamps, which leaves that part of the counter sample buffer unaltered.\n\nEach type of pass has different boundary types and corresponding properties in their descriptor types.\n\n### Sample counters at command boundaries\n\nYou can encode specific commands to sample a counter’s data during a pass for a GPU that supports any of the following boundaries:\n\nYou do this by calling an encoder’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderCommandEncoder\/sampleCounters(sampleBuffer:sampleIndex:barrier:)] method.\n\nThe code example above encodes a sample command between two draw commands. When the GPU reaches the sample command, it samples the counters and copies the results into a counter sample buffer.\n\nEach pass encoder type has its own version of the method.\n\nThe `barrier` parameter for these methods controls whether the pass waits for the GPU to complete all the previous commands in the buffer before sampling the counters (see [doc:\/\/com.apple.metal\/documentation\/Metal\/resource-synchronization]). Each barrier typically reduces performance, but can be useful during development to get accurate and consistent data across multiple runs.",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/Metal\/sampling-gpu-data-into-counter-sample-buffers\ncrawled: 2025-12-02T19:54:45Z\n---\n\n# Sampling GPU data into counter sample buffers\n\n**Article**\n\nRetrieve a GPU’s counter data at a time the GPU supports.\n\n## Overview\n\nYou can sample a GPU device’s performance counter data at different times, including:\n\n- At pipeline stage boundaries\n- Between different Metal commands\n\nTypically, a GPU supports one of these boundary types. For example, Apple silicon supports sampling at the stage boundary because it processes fragments after processing every primitive for a render pass. However, a typical immediate-mode GPU supports sampling between commands.\n\nBefore you can sample a GPU counter, implement the following prerequisite steps:\n\n1. Identify which counters you can sample from an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice] instance (see [doc:\/\/com.apple.metal\/documentation\/Metal\/confirming-which-counters-and-counter-sets-a-gpu-supports]).\n2. Make an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSampleBuffer] instance to store the counter’s data (see [doc:\/\/com.apple.metal\/documentation\/Metal\/creating-a-counter-sample-buffer-to-store-a-gpus-counter-data-during-a-pass]).\n\nThe sections below explain how to identify when you can sample a GPU’s counters, and how to encode commands to retrieve their data.\n\nEach GPU vendor defines its own private data format for its counter sample buffers, which means your app can’t read the contents of each buffer directly. Instead, your app can transform the data from the vendor’s internal format to the standard Metal formats by *resolving* each sample buffer. See [doc:\/\/com.apple.metal\/documentation\/Metal\/converting-a-gpus-counter-data-into-a-readable-format] for the next steps that resolve the data within a counter sample buffer.\n\n### Check which boundaries a GPU supports\n\nYou can inspect a GPU device instance to see whether it supports a specific sample boundary by calling its [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLDevice\/supportsCounterSampling(_:)] method with each [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint] case.\n\n\n\nThis method checks for multiple sample boundaries and returns those the GPU supports in an array.\n\n### Sample counters at stage boundaries\n\nFor a GPU device that can sample counters at stage boundaries ( [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atStageBoundary]), you can sample its counters between the stages of a pass. When the GPU starts or finishes a stage, it samples the counters and copies the results into a counter sample buffer.\n\n\n\nYou tell the GPU which counters to sample by configuring a pass descriptor’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLComputePassDescriptor\/sampleBufferAttachments] property. For example, you can sample the timestamp counters before and after the vertex and fragment stages by configuring an [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderPassDescriptor] instance’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderPassDescriptor\/sampleBufferAttachments] property.\n\n\n\nEach index value tells the GPU where to put a specific counter value within a counter sample buffer. You can skip specific counters by setting an index to [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterDontSample]. For example, you can alter the code example above so that the GPU only samples before and after a fragment stage.\n\n```swift\n    ...\n    sampleAttachment.sampleBuffer = self.counterSampleBuffer;\n    sampleAttachment.startOfVertexSampleIndex = MTLCounterDontSample;\n    sampleAttachment.endOfVertexSampleIndex = MTLCounterDontSample;\n    sampleAttachment.startOfFragmentSampleIndex = 2;\n    sampleAttachment.endOfFragmentSampleIndex = 3;\n}\n```\n\nThis example still stores the fragment counter data in the third and fourth positions within the counter sample buffer (at indexes 2 and 3, respectively). However, it doesn’t sample the vertex stage timestamps, which leaves that part of the counter sample buffer unaltered.\n\nEach type of pass has different boundary types and corresponding properties in their descriptor types.\n\n\n\n### Sample counters at command boundaries\n\nYou can encode specific commands to sample a counter’s data during a pass for a GPU that supports any of the following boundaries:\n\n- [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atDrawBoundary]\n- [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atDispatchBoundary]\n- [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atBlitBoundary]\n- [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLCounterSamplingPoint\/atTileDispatchBoundary]\n\nYou do this by calling an encoder’s [doc:\/\/com.apple.metal\/documentation\/Metal\/MTLRenderCommandEncoder\/sampleCounters(sampleBuffer:sampleIndex:barrier:)] method.\n\n\n\nThe code example above encodes a sample command between two draw commands. When the GPU reaches the sample command, it samples the counters and copies the results into a counter sample buffer.\n\nEach pass encoder type has its own version of the method.\n\n\n\nThe `barrier` parameter for these methods controls whether the pass waits for the GPU to complete all the previous commands in the buffer before sampling the counters (see [doc:\/\/com.apple.metal\/documentation\/Metal\/resource-synchronization]). Each barrier typically reduces performance, but can be useful during development to get accurate and consistent data across multiple runs.\n\n## Counter sample buffers\n\n- **Creating a counter sample buffer to store a GPU’s counter data during a pass**: Make a buffer that provides a place for a GPU to save its runtime performance metrics as it runs a pass.\n- **MTLCounterSampleBufferDescriptor**: A group of properties that configures the counter sample buffers you create with it.\n- **MTLCounterSampleBuffer**: A specialized memory buffer that stores a GPU’s counter set data.\n- **MTLCounterDontSample**: A sentinel value that instructs an encoder to skip sampling a counter as the GPU runs the encoder’s pass.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Make a buffer that provides a place for a GPU to save its runtime performance metrics as it runs a pass.",
          "name" : "Creating a counter sample buffer to store a GPU’s counter data during a pass",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/creating-a-counter-sample-buffer-to-store-a-gpus-counter-data-during-a-pass"
        },
        {
          "description" : "A group of properties that configures the counter sample buffers you create with it.",
          "name" : "MTLCounterSampleBufferDescriptor",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCounterSampleBufferDescriptor"
        },
        {
          "description" : "A specialized memory buffer that stores a GPU’s counter set data.",
          "name" : "MTLCounterSampleBuffer",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCounterSampleBuffer"
        },
        {
          "description" : "A sentinel value that instructs an encoder to skip sampling a counter as the GPU runs the encoder’s pass.",
          "name" : "MTLCounterDontSample",
          "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/MTLCounterDontSample"
        }
      ],
      "title" : "Counter sample buffers"
    }
  ],
  "source" : "appleJSON",
  "title" : "Sampling GPU data into counter sample buffers",
  "url" : "https:\/\/developer.apple.com\/documentation\/Metal\/sampling-gpu-data-into-counter-sample-buffers"
}