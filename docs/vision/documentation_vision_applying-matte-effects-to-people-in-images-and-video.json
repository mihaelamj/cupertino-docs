{
  "abstract" : "Generate image masks for people automatically by using semantic person-segmentation.",
  "codeExamples" : [
    {
      "code" : "\/\/ Create a request to detect face rectangles.\nfacePoseRequest = VNDetectFaceRectanglesRequest { [weak self] request, _ in\n    guard let face = request.results?.first as? VNFaceObservation else { return }\n    \/\/ Generate RGB color intensity values for the face rectangle angles.\n    self?.colors = AngleColors(roll: face.roll, pitch: face.pitch, yaw: face.yaw)\n}\nfacePoseRequest.revision = VNDetectFaceRectanglesRequestRevision3",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Create a request to segment a person from an image.\nsegmentationRequest = VNGeneratePersonSegmentationRequest()\nsegmentationRequest.qualityLevel = .balanced\nsegmentationRequest.outputPixelFormat = kCVPixelFormatType_OneComponent8",
      "language" : "swift"
    },
    {
      "code" : "private func processVideoFrame(_ framePixelBuffer: CVPixelBuffer) {\n    \/\/ Perform the requests on the pixel buffer that contains the video frame.\n    try? requestHandler.perform([facePoseRequest, segmentationRequest],\n                                on: framePixelBuffer,\n                                orientation: .right)\n    \n    \/\/ Get the pixel buffer that contains the mask image.\n    guard let maskPixelBuffer =\n            segmentationRequest.results?.first?.pixelBuffer else { return }\n    \n    \/\/ Process the images.\n    blend(original: framePixelBuffer, mask: maskPixelBuffer)\n}",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Create CIImage objects for the video frame and the segmentation mask.\nlet originalImage = CIImage(cvPixelBuffer: framePixelBuffer).oriented(.right)\nvar maskImage = CIImage(cvPixelBuffer: maskPixelBuffer)\n\n\/\/ Scale the mask image to fit the bounds of the video frame.\nlet scaleX = originalImage.extent.width \/ maskImage.extent.width\nlet scaleY = originalImage.extent.height \/ maskImage.extent.height\nmaskImage = maskImage.transformed(by: .init(scaleX: scaleX, y: scaleY))\n\n\/\/ Define RGB vectors for CIColorMatrix filter.\nlet vectors = [\n    \"inputRVector\": CIVector(x: 0, y: 0, z: 0, w: colors.red),\n    \"inputGVector\": CIVector(x: 0, y: 0, z: 0, w: colors.green),\n    \"inputBVector\": CIVector(x: 0, y: 0, z: 0, w: colors.blue)\n]\n\n\/\/ Create a colored background image.\nlet backgroundImage = maskImage.applyingFilter(\"CIColorMatrix\",\n                                               parameters: vectors)",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Blend the original, background, and mask images.\nlet blendFilter = CIFilter.blendWithRedMask()\nblendFilter.inputImage = originalImage\nblendFilter.backgroundImage = backgroundImage\nblendFilter.maskImage = maskImage\n\n\/\/ Set the new, blended image as current.\ncurrentCIImage = blendFilter.outputImage?.oriented(.left)",
      "language" : "swift"
    }
  ],
  "contentHash" : "6fab00b3c138a9ed43d26abc09639d5a34bfca04b6e85fa1aba6387f93affe31",
  "crawledAt" : "2025-12-04T01:02:31Z",
  "id" : "48609E8D-D64F-4091-80C2-53C09447127A",
  "kind" : "unknown",
  "language" : "swift",
  "module" : "Vision",
  "overview" : "## Overview\n\nYou can use image masks to make selective adjustments to particular areas of an image. For example, the illustration below shows how to use a mask to perform a blend operation to replace the background behind the subject. \n\nIn iOS and tvOS 15 and macOS 12, Vision makes it simple for you to generate image masks for people it finds in images and video by using the [https:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest] class. This new request type brings the semantic person-segmentation capabilities found in frameworks like ARKit and AVFoundation to the Vision framework.\n\nThe sample app uses the front-facing camera to capture video of the user. It runs a person-segmentation request on each video frame to produce an image mask. Then, it uses Core Image to perform a blend operation that replaces the original video frame’s background with an image that the app dynamically generates and colors based on the user’s head movements. Finally, it renders the image on screen using Metal.\n\n### Prepare the Requests\n\nThe app uses two Vision requests to perform its logic: [https:\/\/developer.apple.com\/documentation\/vision\/vndetectfacerectanglesrequest] and [http:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest]. It uses `VNDetectFaceRectanglesRequest` to detect a bounding rectangle around a person’s face. The observation the request produces also includes the [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/2980939-roll], [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/2980940-yaw], and new in iOS and tvOS 15 and macOS 12, the [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/3750998-pitch] angles of the rectangle. The app uses the angles to dynamically calculate background colors as the user moves their head.\n\n`VNGeneratePersonSegmentationRequest` generates an image mask for a person it detects in an image. The app can set the value for request’s [http:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest\/3750989-qualitylevel] property to `.fast`, `.balanced`, or `.accurate`; this value determines the quality of the generated mask as shown in the illustration below.\n\n\n\nBecause the sample processes live video, it chooses `.balanced`, which provides a mixture of accuracy and performance. It also sets the format of the mask image that the request generates to an 8-bit, one-component format where `0` represents black.\n\n### Perform the Requests on a Video Frame\n\nThe sample captures video from the front-facing camera and performs the requests on each frame. After the requests finish processing, the app retrieves the image mask from result of the segmentation request and passes it and original frame to the the app’s `blend(original:mask:)` method for further processing.\n\n### Render the Results\n\nThe sample processes the results of the requests by taking the original frame, the mask image, and a background image that it dynamically generates based on the roll, pitch, and yaw angles of the user’s face. It creates a [http:\/\/developer.apple.com\/documentation\/coreimage\/ciimage] object for each image.\n\nThe app then scales the mask image to fit the bounds of the captured video frame, and dynamically generates a background image using a `CIColorMatrix` filter.\n\nIt blends the images and sets the result as the current image, which causes the view to render it on screen.",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/vision\/applying-matte-effects-to-people-in-images-and-video\ncrawled: 2025-12-04T01:02:31Z\n---\n\n# Applying Matte Effects to People in Images and Video\n\n**Sample Code**\n\nGenerate image masks for people automatically by using semantic person-segmentation.\n\n## Overview\n\nYou can use image masks to make selective adjustments to particular areas of an image. For example, the illustration below shows how to use a mask to perform a blend operation to replace the background behind the subject. \n\nIn iOS and tvOS 15 and macOS 12, Vision makes it simple for you to generate image masks for people it finds in images and video by using the [https:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest] class. This new request type brings the semantic person-segmentation capabilities found in frameworks like ARKit and AVFoundation to the Vision framework.\n\nThe sample app uses the front-facing camera to capture video of the user. It runs a person-segmentation request on each video frame to produce an image mask. Then, it uses Core Image to perform a blend operation that replaces the original video frame’s background with an image that the app dynamically generates and colors based on the user’s head movements. Finally, it renders the image on screen using Metal.\n\n\n\n### Prepare the Requests\n\nThe app uses two Vision requests to perform its logic: [https:\/\/developer.apple.com\/documentation\/vision\/vndetectfacerectanglesrequest] and [http:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest]. It uses `VNDetectFaceRectanglesRequest` to detect a bounding rectangle around a person’s face. The observation the request produces also includes the [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/2980939-roll], [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/2980940-yaw], and new in iOS and tvOS 15 and macOS 12, the [http:\/\/developer.apple.com\/documentation\/vision\/vnfaceobservation\/3750998-pitch] angles of the rectangle. The app uses the angles to dynamically calculate background colors as the user moves their head.\n\n```swift\n\/\/ Create a request to detect face rectangles.\nfacePoseRequest = VNDetectFaceRectanglesRequest { [weak self] request, _ in\n    guard let face = request.results?.first as? VNFaceObservation else { return }\n    \/\/ Generate RGB color intensity values for the face rectangle angles.\n    self?.colors = AngleColors(roll: face.roll, pitch: face.pitch, yaw: face.yaw)\n}\nfacePoseRequest.revision = VNDetectFaceRectanglesRequestRevision3\n```\n\n`VNGeneratePersonSegmentationRequest` generates an image mask for a person it detects in an image. The app can set the value for request’s [http:\/\/developer.apple.com\/documentation\/vision\/vngeneratepersonsegmentationrequest\/3750989-qualitylevel] property to `.fast`, `.balanced`, or `.accurate`; this value determines the quality of the generated mask as shown in the illustration below.\n\n\n\nBecause the sample processes live video, it chooses `.balanced`, which provides a mixture of accuracy and performance. It also sets the format of the mask image that the request generates to an 8-bit, one-component format where `0` represents black.\n\n```swift\n\/\/ Create a request to segment a person from an image.\nsegmentationRequest = VNGeneratePersonSegmentationRequest()\nsegmentationRequest.qualityLevel = .balanced\nsegmentationRequest.outputPixelFormat = kCVPixelFormatType_OneComponent8\n```\n\n### Perform the Requests on a Video Frame\n\nThe sample captures video from the front-facing camera and performs the requests on each frame. After the requests finish processing, the app retrieves the image mask from result of the segmentation request and passes it and original frame to the the app’s `blend(original:mask:)` method for further processing.\n\n```swift\nprivate func processVideoFrame(_ framePixelBuffer: CVPixelBuffer) {\n    \/\/ Perform the requests on the pixel buffer that contains the video frame.\n    try? requestHandler.perform([facePoseRequest, segmentationRequest],\n                                on: framePixelBuffer,\n                                orientation: .right)\n    \n    \/\/ Get the pixel buffer that contains the mask image.\n    guard let maskPixelBuffer =\n            segmentationRequest.results?.first?.pixelBuffer else { return }\n    \n    \/\/ Process the images.\n    blend(original: framePixelBuffer, mask: maskPixelBuffer)\n}\n```\n\n### Render the Results\n\nThe sample processes the results of the requests by taking the original frame, the mask image, and a background image that it dynamically generates based on the roll, pitch, and yaw angles of the user’s face. It creates a [http:\/\/developer.apple.com\/documentation\/coreimage\/ciimage] object for each image.\n\n```swift\n\/\/ Create CIImage objects for the video frame and the segmentation mask.\nlet originalImage = CIImage(cvPixelBuffer: framePixelBuffer).oriented(.right)\nvar maskImage = CIImage(cvPixelBuffer: maskPixelBuffer)\n\n\/\/ Scale the mask image to fit the bounds of the video frame.\nlet scaleX = originalImage.extent.width \/ maskImage.extent.width\nlet scaleY = originalImage.extent.height \/ maskImage.extent.height\nmaskImage = maskImage.transformed(by: .init(scaleX: scaleX, y: scaleY))\n\n\/\/ Define RGB vectors for CIColorMatrix filter.\nlet vectors = [\n    \"inputRVector\": CIVector(x: 0, y: 0, z: 0, w: colors.red),\n    \"inputGVector\": CIVector(x: 0, y: 0, z: 0, w: colors.green),\n    \"inputBVector\": CIVector(x: 0, y: 0, z: 0, w: colors.blue)\n]\n\n\/\/ Create a colored background image.\nlet backgroundImage = maskImage.applyingFilter(\"CIColorMatrix\",\n                                               parameters: vectors)\n```\n\nThe app then scales the mask image to fit the bounds of the captured video frame, and dynamically generates a background image using a `CIColorMatrix` filter.\n\nIt blends the images and sets the result as the current image, which causes the view to render it on screen.\n\n```swift\n\/\/ Blend the original, background, and mask images.\nlet blendFilter = CIFilter.blendWithRedMask()\nblendFilter.inputImage = originalImage\nblendFilter.backgroundImage = backgroundImage\nblendFilter.maskImage = maskImage\n\n\/\/ Set the new, blended image as current.\ncurrentCIImage = blendFilter.outputImage?.oriented(.left)\n```\n\n## Image sequence analysis\n\n- **Detecting human actions in a live video feed**: Identify body movements by sending a person’s pose data from a series of video frames to an action-classification model.\n- **Segmenting and colorizing individuals from a surrounding scene**: Use the Vision framework to isolate and apply colors to people in an image.\n- **VNStatefulRequest**: An abstract request type that builds evidence of a condition over time.\n- **VNGeneratePersonSegmentationRequest**: An object that produces a matte image for a person it finds in the input image.\n- **VNGeneratePersonInstanceMaskRequest**: An object that produces a mask of individual people it finds in the input image.\n- **VNDetectDocumentSegmentationRequest**: An object that detects rectangular regions that contain text in the input image.\n- **VNSequenceRequestHandler**: An object that processes image-analysis requests for each frame in a sequence.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Identify body movements by sending a person’s pose data from a series of video frames to an action-classification model.",
          "name" : "Detecting human actions in a live video feed",
          "url" : "https:\/\/developer.apple.com\/documentation\/CreateML\/detecting-human-actions-in-a-live-video-feed"
        },
        {
          "description" : "Use the Vision framework to isolate and apply colors to people in an image.",
          "name" : "Segmenting and colorizing individuals from a surrounding scene",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/segmenting-and-colorizing-individuals-from-a-surrounding-scene"
        },
        {
          "description" : "An abstract request type that builds evidence of a condition over time.",
          "name" : "VNStatefulRequest",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/VNStatefulRequest"
        },
        {
          "description" : "An object that produces a matte image for a person it finds in the input image.",
          "name" : "VNGeneratePersonSegmentationRequest",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/VNGeneratePersonSegmentationRequest"
        },
        {
          "description" : "An object that produces a mask of individual people it finds in the input image.",
          "name" : "VNGeneratePersonInstanceMaskRequest",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/VNGeneratePersonInstanceMaskRequest"
        },
        {
          "description" : "An object that detects rectangular regions that contain text in the input image.",
          "name" : "VNDetectDocumentSegmentationRequest",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/VNDetectDocumentSegmentationRequest"
        },
        {
          "description" : "An object that processes image-analysis requests for each frame in a sequence.",
          "name" : "VNSequenceRequestHandler",
          "url" : "https:\/\/developer.apple.com\/documentation\/Vision\/VNSequenceRequestHandler"
        }
      ],
      "title" : "Image sequence analysis"
    }
  ],
  "source" : "appleJSON",
  "title" : "Applying Matte Effects to People in Images and Video",
  "url" : "https:\/\/developer.apple.com\/documentation\/vision\/applying-matte-effects-to-people-in-images-and-video"
}