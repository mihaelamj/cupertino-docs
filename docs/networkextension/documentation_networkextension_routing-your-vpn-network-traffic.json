{
  "abstract" : "Configure your VPN to include and exclude some network traffic.",
  "codeExamples" : [
    {
      "code" : "\/\/ Create an internet protocol settings object.\nlet ipv4Settings = NEIPv4Settings(addresses: [ \"192.168.3.4\" ],\n                                  subnetMasks: [ \"255.255.0.0\" ])\n\n\/\/ Specify the types of traffic to include and exclude.\nipv4Settings.includedRoutes = [ NEIPv4Route(destinationAddress: \"192.168.0.0\",\n                                            subnetMask: \"255.255.0.0\") ]",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Specify the types of traffic to exclude.\nipv4Settings.excludedRoutes = [ NEIPv4Route(destinationAddress: \"192.168.5.6\",\n                                            subnetMask: \"255.255.255.255\")]",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Create a network settings object with the internet protocol settings.\nlet networkSettings = NEPacketTunnelNetworkSettings(tunnelRemoteAddress: \"127.0.0.1\")\nnetworkSettings.ipv4Settings = ipv4Settings\n\n\/\/ Set the packet tunnel provider's settings.\nsetTunnelNetworkSettings(networkSettings) { error in\n    completionHandler(error)\n}",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Create the tunnel provider configuration.\nlet protocolConfiguration = NETunnelProviderProtocol()\nprotocolConfiguration.serverAddress = \"https:\/\/127.0.0.1\"\n\n\/\/ Include network traffic.\nprotocolConfiguration.includeAllNetworks = true",
      "language" : "swift"
    },
    {
      "code" : "\/\/ Include network traffic.\nprotocolConfiguration.includeAllNetworks = true\n\n\/\/ Except for local network, APNs, and cellular traffic.\nprotocolConfiguration.excludeLocalNetworks = true\nprotocolConfiguration.excludeAPNs = true\nprotocolConfiguration.excludeCellularServices = true",
      "language" : "swift"
    },
    {
      "code" : "protocolConfiguration.enforceRoutes = true",
      "language" : "swift"
    },
    {
      "code" : "protocolConfiguration.excludeLocalNetworks = true\nprotocolConfiguration.enforceRoutes = true",
      "language" : "swift"
    }
  ],
  "contentHash" : "03a6e0b79f2dd4d384be0d923368da119599894ed15a56cbfffe3dece322f89f",
  "crawledAt" : "2025-12-02T12:50:37Z",
  "id" : "AB8E6EF2-3481-49E2-9C37-ED2E9027D5CD",
  "kind" : "article",
  "module" : "Network Extension",
  "overview" : "## Overview\n\nYou can control some of the network traffic that the system routes to and from a personal VPN, packet tunnel provider, or app proxy provider. The Network Extension framework provides routing settings for all VPN types, and some settings specific to personal VPNs and packet tunnel providers. You can configure the routing of packets to per-app VPNs using rules, and make exceptions to always-on VPNs on MDM supervised devices.\n\nFor the complete APIs to create the different types of VPNs, see [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/personal-vpn], [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/packet-tunnel-provider], and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/app-proxy-provider].\n\n### Configure traffic for a packet tunnel provider\n\nYou configure a packet tunnel provider’s virtual interface by passing an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance to the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider\/setTunnelNetworkSettings(_:completionHandler:)] method of an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider] instance. The system uses the routing settings you provide in the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance by default.\n\nTo route traffic through the packet tunnel provider, create a homogenous array of [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] or [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] elements and assign it to the corresponding settings property, either:\n\nThe [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] objects that you pass in these arrays specify the types of traffic that the VPN includes. For example, the following code specifies the traffic for internet protocol version 4:\n\nIf you include the default route (`0.0.0.0\/0` or `::\/0`) in the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Settings\/includedRoutes] property, the system routes network traffic that doesn’t match some other more specific rule in the system routing table through the VPN.\n\nTo exclude traffic from the VPN, create a homogenous array of [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] or [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] elements and assign it to the corresponding settings property, either:\n\nThe route instances specify the types of traffic that the VPN excludes.\n\nThen set the packet tunnel provider’s settings to an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance that contains the internet protocol settings using the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider\/setTunnelNetworkSettings(_:completionHandler:)] method.\n\nNote that the system routing table supersedes the `includedRoutes` and `excludedRoutes` properties. For example, if a table routes traffic to hosts on the local network, those routes supersede these properties.\n\nAlso, if an app creates a network connection that routes traffic over a specific network interface, called *scoping*, then it supersedes the system routing table.\n\n### Route additional traffic through a personal VPN or packet tunnel provider\n\nTo route network traffic that’s not related to designated system services necessary for maintaining expected device functionality through a personal VPN or packet tunnel provider, set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property to `true`.\n\nThen the system scopes network connections, with certain exceptions, to the VPN tunnel.\n\nAlso, after the VPN transitions from the disconnected ([doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNStatus\/disconnected]) to the connecting ([doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNStatus\/connecting]) state, the system doesn’t close TCP connections, but drops subsequent packets that previously established network connections send or receive.\n\nWhen the VPN transitions away from the connected state, the system drops network traffic. For example, the system drops the network traffic when a device transitions from a Wi-Fi network to a cellular network, and while the VPN is in the process of reconnecting to the VPN server over the cellular network.\n\nThe system always excludes the following traffic from the VPN, and the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property has no impact on it:\n\n### Exclude some traffic from a personal VPN or packet tunnel provider\n\nYou can make other exceptions when routing network traffic through a VPN using other [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol] properties. If you set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property to `true`, you can exclude specific types of traffic from the VPN.\n\n### Enforce the inclusions and exclusions for a packet tunnel provider\n\nTo enforce the `includedRoutes` and `excludedRoutes` properties, set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] property to `true`.\n\nThe system scopes the included routes to the VPN and the excluded routes to the current primary network interface, such as a Wi-Fi or a cellular network. This property supersedes the system routing table and scoping operations by apps. It’s also mutually exclusive from the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property. If you set `includeAllNetworks` to `true`, the system ignores the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] property.\n\nIf you set both the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/excludeLocalNetworks] properties to `true`, the system excludes network connections to hosts on the local network from the enforce routes behavior.\n\nFor example, if the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Settings\/includedRoutes] property contains the `10.0.0.0\/8` address and the local network subnet is `10.10.0.0\/16`, the system scopes network connections to hosts in the `10.0.0.0\/8` network to the VPN, but not those in the `10.10.0.0\/16` network.\n\n### Route network traffic to and from specific apps\n\nYou can use two types of per-app VPN features in the Network Extension framework to control network traffic to and from specific apps. You can use a packet tunnel provider to scope network connections from an app to the VPN, or use an app proxy to divert network connections from an app to a transparent proxy. To programmatically configure a per-app VPN, use the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelProvider] class for packet tunnels, and the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEAppProxyProviderManager] class for app proxies.\n\nFor packet tunnel providers, use the per-app VPN rules to override any scoping operations that apps perform.\n\nThe system honors your disconnect on-demand rules. If you enable the on-demand feature (set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNManager\/isOnDemandEnabled] property to `true`) and provide a disconnect app rule, the system bypasses the per-app VPN for devices on the network that match the on-demand rule criteria.\n\nNote that the apps generally can’t communicate over the network at all unless the VPN is in the connected state.\n\nFor more information on per-app VPN features, see the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProviderManager] class overview.\n\n### Exclude traffic from an always-on VPN\n\nIn iOS, you can exclude some network traffic from an always-on VPN device configuration. An always-on VPN acts as the only connection to the internet for an iOS device. You enable this feature by installing an always-on VPN profile on an MDM-supervised device.\n\nThen the system routes network traffic on the device through the VPN with some exclusions. When the VPN isn’t in a connected state, and while the device starts up before the VPN starts, the system drops network traffic. For example, the VPN disconnects when the system transitions from a Wi-Fi network or the user disables the VPN.\n\nThe system always excludes network control plane traffic — such as DHCP — but only excludes captive portal negotiation traffic, if you enable the `AllowAllCaptiveNetworkPlugins`, `AllowCaptiveWebSheet`, or `AllowedCaptiveNetworkPlugins` payload keys in the profile.\n\nYou can exclude other traffic using the following keys in the always-on VPN profile:\n\nFor more information on MDM and configuring always-on VPNs, see [doc:\/\/com.apple.documentation\/documentation\/DeviceManagement\/configuring-multiple-devices-using-profiles] and [doc:\/\/com.apple.documentation\/documentation\/DeviceManagement\/profile-specific-payload-keys].",
  "rawMarkdown" : "---\nsource: https:\/\/developer.apple.com\/documentation\/networkextension\/routing-your-vpn-network-traffic\ncrawled: 2025-12-02T12:50:37Z\n---\n\n# Routing your VPN network traffic\n\n**Article**\n\nConfigure your VPN to include and exclude some network traffic.\n\n## Overview\n\nYou can control some of the network traffic that the system routes to and from a personal VPN, packet tunnel provider, or app proxy provider. The Network Extension framework provides routing settings for all VPN types, and some settings specific to personal VPNs and packet tunnel providers. You can configure the routing of packets to per-app VPNs using rules, and make exceptions to always-on VPNs on MDM supervised devices.\n\nFor the complete APIs to create the different types of VPNs, see [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/personal-vpn], [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/packet-tunnel-provider], and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/app-proxy-provider].\n\n### Configure traffic for a packet tunnel provider\n\nYou configure a packet tunnel provider’s virtual interface by passing an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance to the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider\/setTunnelNetworkSettings(_:completionHandler:)] method of an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider] instance. The system uses the routing settings you provide in the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance by default.\n\nTo route traffic through the packet tunnel provider, create a homogenous array of [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] or [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] elements and assign it to the corresponding settings property, either:\n\n- The [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Settings\/includedRoutes] property of the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings\/ipv4Settings] property\n- The [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Settings\/includedRoutes] property of the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings\/ipv6Settings] property\n\nThe [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] objects that you pass in these arrays specify the types of traffic that the VPN includes. For example, the following code specifies the traffic for internet protocol version 4:\n\n```swift\n\/\/ Create an internet protocol settings object.\nlet ipv4Settings = NEIPv4Settings(addresses: [ \"192.168.3.4\" ],\n                                  subnetMasks: [ \"255.255.0.0\" ])\n\n\/\/ Specify the types of traffic to include and exclude.\nipv4Settings.includedRoutes = [ NEIPv4Route(destinationAddress: \"192.168.0.0\",\n                                            subnetMask: \"255.255.0.0\") ]\n```\n\nIf you include the default route (`0.0.0.0\/0` or `::\/0`) in the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Settings\/includedRoutes] property, the system routes network traffic that doesn’t match some other more specific rule in the system routing table through the VPN.\n\nTo exclude traffic from the VPN, create a homogenous array of [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Route] or [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Route] elements and assign it to the corresponding settings property, either:\n\n- The [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Settings\/excludedRoutes] property of the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings\/ipv4Settings] property\n- The [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv6Settings\/excludedRoutes] property of the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings\/ipv6Settings] property\n\nThe route instances specify the types of traffic that the VPN excludes.\n\n```swift\n\/\/ Specify the types of traffic to exclude.\nipv4Settings.excludedRoutes = [ NEIPv4Route(destinationAddress: \"192.168.5.6\",\n                                            subnetMask: \"255.255.255.255\")]\n```\n\nThen set the packet tunnel provider’s settings to an [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelNetworkSettings] instance that contains the internet protocol settings using the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProvider\/setTunnelNetworkSettings(_:completionHandler:)] method.\n\n```swift\n\/\/ Create a network settings object with the internet protocol settings.\nlet networkSettings = NEPacketTunnelNetworkSettings(tunnelRemoteAddress: \"127.0.0.1\")\nnetworkSettings.ipv4Settings = ipv4Settings\n\n\/\/ Set the packet tunnel provider's settings.\nsetTunnelNetworkSettings(networkSettings) { error in\n    completionHandler(error)\n}\n```\n\nNote that the system routing table supersedes the `includedRoutes` and `excludedRoutes` properties. For example, if a table routes traffic to hosts on the local network, those routes supersede these properties.\n\nAlso, if an app creates a network connection that routes traffic over a specific network interface, called *scoping*, then it supersedes the system routing table.\n\n### Route additional traffic through a personal VPN or packet tunnel provider\n\nTo route network traffic that’s not related to designated system services necessary for maintaining expected device functionality through a personal VPN or packet tunnel provider, set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property to `true`.\n\n```swift\n\/\/ Create the tunnel provider configuration.\nlet protocolConfiguration = NETunnelProviderProtocol()\nprotocolConfiguration.serverAddress = \"https:\/\/127.0.0.1\"\n\n\/\/ Include network traffic.\nprotocolConfiguration.includeAllNetworks = true\n```\n\nThen the system scopes network connections, with certain exceptions, to the VPN tunnel.\n\nAlso, after the VPN transitions from the disconnected ([doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNStatus\/disconnected]) to the connecting ([doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNStatus\/connecting]) state, the system doesn’t close TCP connections, but drops subsequent packets that previously established network connections send or receive.\n\nWhen the VPN transitions away from the connected state, the system drops network traffic. For example, the system drops the network traffic when a device transitions from a Wi-Fi network to a cellular network, and while the VPN is in the process of reconnecting to the VPN server over the cellular network.\n\nThe system always excludes the following traffic from the VPN, and the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property has no impact on it:\n\n- Network control plane traffic that maintains a device’s connection to the local network, such as DHCP traffic, or that communicates directly with the VPN server.\n- Captive portal negotiation network traffic that authorizes a device with a Wi-Fi hotspot. For example, a coffee shop Wi-Fi hotspot may require that the user accept legal terms and conditions before the hotspot grants the device access to the internet.\n- Certain cellular services traffic that uses the cellular network only, such as VoLTE.\n- Traffic that communicates with a companion device, such as an Apple Watch.\n\n### Exclude some traffic from a personal VPN or packet tunnel provider\n\nYou can make other exceptions when routing network traffic through a VPN using other [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol] properties. If you set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property to `true`, you can exclude specific types of traffic from the VPN.\n\n- To exclude network connections to hosts on the local network — such as AirPlay, AirDrop, and CarPlay — set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/excludeLocalNetworks] property to `true`.\n- To exclude cellular services network traffic — such as Wi-Fi Calling, MMS, SMS, and Visual Voicemail — set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/excludeCellularServices] property to `true`. This property doesn’t impact services that use the cellular network only — such as VoLTE — which the system automatically excludes.\n- To exclude Apple Push Notification services (APNs) traffic, set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/excludeAPNs] property to `true`. Many system and app features use APNs, which may not work reliably when you route APNs through the VPN, resulting in missed or delayed push notifications and iMessages.\n\n```swift\n\/\/ Include network traffic.\nprotocolConfiguration.includeAllNetworks = true\n\n\/\/ Except for local network, APNs, and cellular traffic.\nprotocolConfiguration.excludeLocalNetworks = true\nprotocolConfiguration.excludeAPNs = true\nprotocolConfiguration.excludeCellularServices = true\n```\n\n### Enforce the inclusions and exclusions for a packet tunnel provider\n\nTo enforce the `includedRoutes` and `excludedRoutes` properties, set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] property to `true`.\n\n```swift\nprotocolConfiguration.enforceRoutes = true\n```\n\nThe system scopes the included routes to the VPN and the excluded routes to the current primary network interface, such as a Wi-Fi or a cellular network. This property supersedes the system routing table and scoping operations by apps. It’s also mutually exclusive from the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/includeAllNetworks] property. If you set `includeAllNetworks` to `true`, the system ignores the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] property.\n\nIf you set both the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/enforceRoutes] and [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNProtocol\/excludeLocalNetworks] properties to `true`, the system excludes network connections to hosts on the local network from the enforce routes behavior.\n\n```swift\nprotocolConfiguration.excludeLocalNetworks = true\nprotocolConfiguration.enforceRoutes = true\n```\n\nFor example, if the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEIPv4Settings\/includedRoutes] property contains the `10.0.0.0\/8` address and the local network subnet is `10.10.0.0\/16`, the system scopes network connections to hosts in the `10.0.0.0\/8` network to the VPN, but not those in the `10.10.0.0\/16` network.\n\n### Route network traffic to and from specific apps\n\nYou can use two types of per-app VPN features in the Network Extension framework to control network traffic to and from specific apps. You can use a packet tunnel provider to scope network connections from an app to the VPN, or use an app proxy to divert network connections from an app to a transparent proxy. To programmatically configure a per-app VPN, use the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEPacketTunnelProvider] class for packet tunnels, and the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEAppProxyProviderManager] class for app proxies.\n\nFor packet tunnel providers, use the per-app VPN rules to override any scoping operations that apps perform.\n\n- For macOS apps, use the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProviderManager\/appRules] property to associate MDM-managed apps with the per-app VPN configuration. Then configure exclusions using the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProviderManager\/excludedDomains] property. Set this property to a list of domain names that you want to exclude from the per-app VPN.\n- For iOS apps, create rules using the MDM system and access the rules in your code using the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProviderManager\/copyAppRules()] method.\n\nThe system honors your disconnect on-demand rules. If you enable the on-demand feature (set the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NEVPNManager\/isOnDemandEnabled] property to `true`) and provide a disconnect app rule, the system bypasses the per-app VPN for devices on the network that match the on-demand rule criteria.\n\nNote that the apps generally can’t communicate over the network at all unless the VPN is in the connected state.\n\nFor more information on per-app VPN features, see the [doc:\/\/com.apple.networkextension\/documentation\/NetworkExtension\/NETunnelProviderManager] class overview.\n\n### Exclude traffic from an always-on VPN\n\nIn iOS, you can exclude some network traffic from an always-on VPN device configuration. An always-on VPN acts as the only connection to the internet for an iOS device. You enable this feature by installing an always-on VPN profile on an MDM-supervised device.\n\nThen the system routes network traffic on the device through the VPN with some exclusions. When the VPN isn’t in a connected state, and while the device starts up before the VPN starts, the system drops network traffic. For example, the VPN disconnects when the system transitions from a Wi-Fi network or the user disables the VPN.\n\nThe system always excludes network control plane traffic — such as DHCP — but only excludes captive portal negotiation traffic, if you enable the `AllowAllCaptiveNetworkPlugins`, `AllowCaptiveWebSheet`, or `AllowedCaptiveNetworkPlugins` payload keys in the profile.\n\nYou can exclude other traffic using the following keys in the always-on VPN profile:\n\n- `ApplicationExceptions` ([doc:\/\/com.apple.documentation\/documentation\/devicemanagement\/vpn\/alwayson\/applicationexceptionelement]) — specifies apps to exclude from an always-on VPN.\n- `ServiceExceptions` ([doc:\/\/com.apple.documentation\/documentation\/devicemanagement\/vpn\/alwayson\/serviceexceptionelement]) — specifies services to exclude from an always-on VPN. Possible values are `VoiceMail`, `AirPrint`, and `CellularServices`.\n\nFor more information on MDM and configuring always-on VPNs, see [doc:\/\/com.apple.documentation\/documentation\/DeviceManagement\/configuring-multiple-devices-using-profiles] and [doc:\/\/com.apple.documentation\/documentation\/DeviceManagement\/profile-specific-payload-keys].\n\n## Virtual private networks\n\n- **Personal VPN**: Create and manage a VPN configuration that uses one of the built-in VPN protocols (IPsec or IKEv2).\n- **Packet tunnel provider**: Implement a VPN client for a packet-oriented, custom VPN protocol.\n- **App proxy provider**: Implement a VPN client for a flow-oriented, custom VPN protocol.\n\n",
  "sections" : [
    {
      "content" : "",
      "items" : [
        {
          "description" : "Create and manage a VPN configuration that uses one of the built-in VPN protocols (IPsec or IKEv2).",
          "name" : "Personal VPN",
          "url" : "https:\/\/developer.apple.com\/documentation\/NetworkExtension\/personal-vpn"
        },
        {
          "description" : "Implement a VPN client for a packet-oriented, custom VPN protocol.",
          "name" : "Packet tunnel provider",
          "url" : "https:\/\/developer.apple.com\/documentation\/NetworkExtension\/packet-tunnel-provider"
        },
        {
          "description" : "Implement a VPN client for a flow-oriented, custom VPN protocol.",
          "name" : "App proxy provider",
          "url" : "https:\/\/developer.apple.com\/documentation\/NetworkExtension\/app-proxy-provider"
        }
      ],
      "title" : "Virtual private networks"
    }
  ],
  "source" : "appleJSON",
  "title" : "Routing your VPN network traffic",
  "url" : "https:\/\/developer.apple.com\/documentation\/networkextension\/routing-your-vpn-network-traffic"
}